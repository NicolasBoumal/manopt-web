<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Manopt – Describing the cost function</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./icon.png" rel="icon" type="image/png">
<script src="site_libs/cookie-consent/cookie-consent.js"></script>
<link href="site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-71FCE8T97E"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-71FCE8T97E', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>
<script>

window.MathJax = {

    tex: {

      inlineMath: [['$', '$'], ['\\(', '\\)']],

      macros: {

        reals: "\\mathbb{R}",

        inner: ["\\left\\langle #1, #2 \\right\\rangle", 2],

        smallinner: ["\\langle #1, #2 \\rangle", 2],

        innersmall: ["\\langle #1, #2 \\rangle", 2],

        innerbig: ["\\big\\langle #1, #2 \\big\\rangle", 2],

        sqfrobnorm: ["\\left\\|#1\\right\\|_{\\mathrm{F}}^2", 1],

        sqfrobnormsmall: ["\\|#1\\|_{\\mathrm{F}}^2", 1],

        sqfrobnormbig: ["\\big\\|#1\\big\\|_{\\mathrm{F}}^2", 1],

        calM: "\\mathcal{M}",

        calN: "\\mathcal{N}",

        calA: "\\mathcal{A}",

        T: "\\mathrm{T}",

        skeww: "\\mathrm{skew}",

        symm: "\\mathrm{sym}",

        Sym: "\\mathrm{Sym}",

        Proj: "\\mathrm{Proj}",

        grad: "\\mathrm{grad}",

        Hess: "\\mathrm{Hess}",

        Retr: "\\mathrm{R}",

        D: "\\mathrm{D}",

        calE: "\\mathcal{E}",

        Stnp: "\\mathrm{St}(n,p)",

        Rnp: "\\mathbb{R}^{n \\times p}",

        Rmp: "\\mathbb{R}^{m \\times p}",

        Rnr: "\\mathbb{R}^{n \\times r}",

        Rrn: "\\mathbb{R}^{r \\times n}",

        Rmr: "\\mathbb{R}^{m \\times r}",

        Rnn: "\\mathbb{R}^{n \\times n}",

        Rmn: "\\mathbb{R}^{m \\times n}",

        Rpp: "\\mathbb{R}^{p \\times p}",

        Rmnr: "\\mathbb{R}^{m \\times n}_r",

        Rmnlr: "\\mathbb{R}^{m \\times n}_{\\leq r}",

        Rn: "\\mathbb{R}^{n}",

        Rm: "\\mathbb{R}^{m}",

        Rp: "\\mathbb{R}^{p}",

        Rd: "\\mathbb{R}^{d}",

        Rk: "\\mathbb{R}^{k}",

        Sn: "\\mathbb{S}^{n}",

        Sm: "\\mathbb{S}^{m}",

        Sd: "\\mathbb{S}^{d-1}",

        trace: "\\mathrm{Tr}",

        Trace: "\\mathrm{Tr}",

        diag: "\\mathrm{diag}",

        sign: "\\mathrm{sign}",

        Od: "\\mathrm{O}(d)",

        On: "\\mathrm{O}(n)",

        Om: "\\mathrm{O}(m)",

        SOd: "\\mathrm{SO}(d)",

        SOn: "\\mathrm{SO}(n)",

        rank: "\\mathrm{rank}",

        frakX: "\\mathfrak{X}",

        frakF: "\\mathfrak{F}",

        One: "\\mathbf{1}",

        dist: "\\mathrm{dist}",

        calP: "\\mathcal{P}",

        calK: "\\mathcal{K}",

        Rdd: "\\mathbb{R}^{d \\times d}",

        calU: "\\mathcal{U}",

        calV: "\\mathcal{V}",

        calW: "\\mathcal{W}",

        Exp: "\\mathrm{Exp}",

        Log: "\\mathrm{Log}",

        inj: "\\mathrm{inj}",

        dom: "\\operatorname{dom}",

        bigger: "<",

        dt: "\\mathrm{d}t",

        transpose: "^\\top\\! ",

        sigmamax: "\\sigma_{\\mathrm{max}}",

        sigmamin: "\\sigma_{\\mathrm{min}}",

        lambdamax: "\\lambda_{\\mathrm{max}}",

        lambdamin: "\\lambda_{\\mathrm{min}}",

        TODO: ["\\textcolor{red}{[\\textrm{#1}]}", 1]

      }

    },

    svg: {

      fontCache: 'global'

    }

  };

</script>



<script>

  window.addEventListener('load', function() {

    document.getElementById("cc-nb-title").innerHTML = "May we use cookies for anonymized analytics?";

    // to improve your browsing experience on our website, 

    document.getElementById("cc-nb-text").innerHTML = "We would like to use cookies to analyze our website traffic, and to understand where our visitors are coming from.";

  });

</script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Manopt - Describing the cost function">
<meta property="og:description" content="And its derivatives (gradient, Hessian)">
<meta property="og:site_name" content="Manopt">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Manopt</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorial" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorial</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorial">    
        <li>
    <a class="dropdown-item" href="./gettingstarted.html">
 <span class="dropdown-text">Getting started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./firstexample.html">
 <span class="dropdown-text">A first example</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./manifolds.html">
 <span class="dropdown-text">Manifolds</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./costdescription.html">
 <span class="dropdown-text">Cost functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./solvers.html">
 <span class="dropdown-text">Solvers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./tools.html">
 <span class="dropdown-text">Helpful tools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./core.html">
 <span class="dropdown-text">Core tools</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./learning.html"> 
<span class="menu-text">Learning</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./downloads.html"> 
<span class="menu-text">Downloads</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./forum.html"> 
<span class="menu-text">Forum</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/NicolasBoumal/manopt" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:manopttoolbox@gmail.com"> <i class="bi bi-envelope-at" role="img" aria-label="E-mail">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./costdescription.html">Cost functions</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gettingstarted.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./firstexample.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A first example</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./manifolds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Manifolds</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./costdescription.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Cost functions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solvers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Solvers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Helpful tools</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core tools</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#general-philosophy" id="toc-general-philosophy" class="nav-link active" data-scroll-target="#general-philosophy">General philosophy <img src="images/icon_salute.gif" class="img-fluid"></a></li>
  <li><a href="#one-example-five-ways" id="toc-one-example-five-ways" class="nav-link" data-scroll-target="#one-example-five-ways">One example, five ways</a>
  <ul class="collapse">
  <li><a href="#the-common-way-via-euclidean-extension" id="toc-the-common-way-via-euclidean-extension" class="nav-link" data-scroll-target="#the-common-way-via-euclidean-extension">The common way: via Euclidean extension</a></li>
  <li><a href="#coding-the-riemannian-derivatives-manually" id="toc-coding-the-riemannian-derivatives-manually" class="nav-link" data-scroll-target="#coding-the-riemannian-derivatives-manually">Coding the Riemannian derivatives manually</a></li>
  <li><a href="#using-automatic-differentiation" id="toc-using-automatic-differentiation" class="nav-link" data-scroll-target="#using-automatic-differentiation">Using automatic differentiation</a></li>
  <li><a href="#fewer-redundant-computations-with-costgrad" id="toc-fewer-redundant-computations-with-costgrad" class="nav-link" data-scroll-target="#fewer-redundant-computations-with-costgrad">Fewer redundant computations with <code>costgrad</code></a></li>
  <li><a href="#using-the-store-caching-system" id="toc-using-the-store-caching-system" class="nav-link" data-scroll-target="#using-the-store-caching-system">Using the <code>store</code> caching system</a></li>
  </ul></li>
  <li><a href="#all-the-ways-to-describe-the-cost" id="toc-all-the-ways-to-describe-the-cost" class="nav-link" data-scroll-target="#all-the-ways-to-describe-the-cost">All the ways to describe the cost</a></li>
  <li><a href="#accessing-the-cost-gradient-and-hessian" id="toc-accessing-the-cost-gradient-and-hessian" class="nav-link" data-scroll-target="#accessing-the-cost-gradient-and-hessian">Accessing the cost, gradient and Hessian</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Describing the cost function</h1>
<p class="subtitle lead">And its derivatives (gradient, Hessian)</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="general-philosophy" class="level2">
<h2 class="anchored" data-anchor-id="general-philosophy">General philosophy <img src="images/icon_salute.gif" class="img-fluid"></h2>
<p>An optimization problem in Manopt is represented as a <code>problem</code> structure. The latter must include a field <code>problem.M</code> which contains a structure describing a manifold, as obtained from <a href="./manifolds.html">a factory</a>. On top of this, the problem structure must include some fields that describe the cost function <span class="math inline">\(f\)</span> to be minimized and, possibly, its derivatives. This is done with function handles.</p>
<p>The solvers do <em>not</em> query these function handles directly. Instead, they call core (internal) tools such as <code>getCost</code>, <code>getGradient</code>, <code>getHessian</code>, etc. These tools consider the available fields in the problem structure and “do their best” to return the requested object.</p>
<p>As a result, we gain great flexibility in the cost function description. Indeed, as the needs grow during the life-cycle of the toolbox and new ways of describing the cost function become necessary, it suffices to update the core <code>get*</code> tools to take these new ways into account. This has made it much easier over time to incorporate (and improve) caching. Also, if a solver requests an object that is not available, then Manopt can automatically fall back to an approximation. </p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Try to provide the gradient
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you do not provide the gradient and a solver queries it, then Manopt falls back to finite differences of the cost function to approximate the Riemannian gradient. This requires building an orthonormal basis for the tangent space (that’s expensive) and then querying the cost function value along each basis vector (that’s <span class="math inline">\(\dim \mathcal{M}\)</span> calls). Solvers will still run, but this feature is included only for convenience when prototyping.</p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
It’s fine to omit the Hessian
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you do not provide the Hessian and a solver queries it, then Manopt falls back to finite differences of the gradient to approximate the Hessian. This is typically good enough, and often has a computational cost similar to evaluating the true Hessian. You can control this further with <a href="https://github.com/NicolasBoumal/manopt/blob/master/manopt/solvers/hessianapproximations/approxhessianFD.m"><code>approxhessianFD</code></a>.</p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check your derivatives
</div>
</div>
<div class="callout-body-container callout-body">
<p>Regardless of how you implement the gradient, make sure to check that it is correct by running <code>checkgradient(problem)</code> at least once. Likewise, check the Hessian with <code>checkhessian(problem)</code>. See the <a href="./tools.html">tools</a> page for more.</p>
</div>
</div>
</section>
<section id="one-example-five-ways" class="level2">
<h2 class="anchored" data-anchor-id="one-example-five-ways">One example, five ways</h2>
<p>Similarly to the <a href="./firstexample.html">first example</a>, consider minimizing <span class="math display">\[
  f(x) = \frac{1}{2} x^\top A x
\]</span> for <span class="math inline">\(x\)</span> on the unit sphere in <span class="math inline">\(\mathbb{R}^n\)</span>, where <span class="math inline">\(A\)</span> is a symmetric matrix. The base code could look something like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="va">n</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> <span class="va">randsym</span>(<span class="va">n</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">M</span> <span class="op">=</span> <span class="va">spherefactory</span>(<span class="va">n</span>)<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">% ... define the cost: see below</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="va">x</span> <span class="op">=</span> <span class="va">trustregions</span>(<span class="va">problem</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The cost function can be specified by adding fields to the <code>problem</code> structure. Let us go through a few different ways to do that.</p>
<section id="the-common-way-via-euclidean-extension" class="level3">
<h3 class="anchored" data-anchor-id="the-common-way-via-euclidean-extension">The common way: via Euclidean extension</h3>
<p>If we think of <span class="math inline">\(f\)</span> as a function on <span class="math inline">\(\mathbb{R}^n\)</span> (ignoring the restriction to the sphere), then the gradient and Hessian of <span class="math inline">\(f\)</span> are easily derived: <span class="math display">\[
\begin{align}
  \nabla f(x) = Ax, &amp;&amp; \nabla^2 f(x)[u] = Au.
\end{align}
\]</span> We think of this approach as “extending” the function from the sphere to the embedding space, which is the Euclidean space <span class="math inline">\(\mathbb{R}^n\)</span>. You can tell Manopt what the gradient and Hessian for that Euclidean extension are using the fields <code>egrad</code> and <code>ehess</code>, as follows (mind the <code>e</code> for Euclidean or embedding):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">egrad</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">ehess</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span>) <span class="va">A</span><span class="op">*</span><span class="va">u</span><span class="op">;</span> <span class="co">% optional</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Manopt takes care of converting these to the Riemannian gradient and Hessian of <span class="math inline">\(f\)</span> on the sphere, using <code>problem.M.egrad2rgrad</code> and <code>problem.M.ehess2rhess</code>: this is automatic.</p>
<p>A few comments:</p>
<ul>
<li>It is fine to omit <code>ehess</code>, but try not to omit <code>egrad</code> (see earlier comments).</li>
<li>The computation <code>A*x</code> is redundant between <code>cost</code> and <code>egrad</code>: more on this later.</li>
<li>The input to <code>egrad</code> is a point <span class="math inline">\(x\)</span>. The output is a vector in the <em>embedding space</em>, corresponding to <span class="math inline">\(\nabla f(x)\)</span>.</li>
<li>The inputs to <code>ehess</code> are a point <span class="math inline">\(x\)</span> and a <em>tangent vector</em> <span class="math inline">\(u\)</span> at <span class="math inline">\(x\)</span>. The output is a vector in the <em>embedding space</em>, corresponding to <span class="math inline">\(\nabla^2 f(x)[u]\)</span>. </li>
</ul>
<p>Mind the distinction between tangent vectors and vectors in the embedding space. For many manifolds, these are numerically represented in the same way, so the distinction does not matter (e.g., for <code>spherefactory</code> and <code>stiefelfactory</code>). However, some manifolds use different numerical representations (e.g., <code>rotationsfactory</code>). For those, you may want to call <code>M.tangent2ambient(x, u)</code> to obtain the embedding space equivalent of <code>u</code>. Read the <code>help</code> section of your manifold factory to make sure.</p>
</section>
<section id="coding-the-riemannian-derivatives-manually" class="level3">
<h3 class="anchored" data-anchor-id="coding-the-riemannian-derivatives-manually">Coding the Riemannian derivatives manually</h3>
<p>There are instances where it is more natural or more efficient to describe the Riemannian derivatives directly (as opposed to the Euclidean extension approach), though this is not common.</p>
<p>One example where this is preferred is when computing an <a href="https://github.com/NicolasBoumal/manopt/blob/master/examples/positive_definite_intrinsic_mean.m">intrinsic mean</a>. There, the cost function involves the squared Riemannian distance, whose Riemannian gradient is the logarithmic map.</p>
<p>In our running example, the sphere is a <em>Riemannian submanifold</em> of <span class="math inline">\(\mathbb{R}^n\)</span>. Therefore,</p>
<ul>
<li>The Riemannian gradient is the orthogonal projection of <span class="math inline">\(\nabla f(x)\)</span> to the tangent space at <span class="math inline">\(x\)</span> (see Proposition 3.61 in <a href="https://www.nicolasboumal.net/book">this book</a>). The projector is available in <code>problem.M.proj</code>: <span class="math display">\[\grad f(x) = \Proj_x(\nabla f(x)).\]</span></li>
<li>The Riemannian Hessian at <span class="math inline">\(x\)</span> along <span class="math inline">\(u\)</span> is the projection of the derivative of the <em>Riemannian</em> gradient at <span class="math inline">\(x\)</span> along <span class="math inline">\(u\)</span> (see Corollary 5.16 in <a href="https://www.nicolasboumal.net/book">the same book</a>): <span class="math display">\[\Hess f(x)[u] = \Proj_x(\D\grad f(x)[u]).\]</span></li>
</ul>
<p>For the unit sphere, <span class="math inline">\(\Proj_x(u) = u - (x^\top u)x\)</span>. It is then an exercise to work out the expressions above.</p>
<p>You can specify the Riemannian gradient and Hessian using the fields <code>grad</code> and <code>hess</code> (no <code>e</code>), as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">grad</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="va">problem</span>.<span class="va">M</span>.<span class="va">proj</span>(<span class="va">x</span><span class="op">,</span> <span class="va">A</span><span class="op">*</span><span class="va">x</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">hess</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span>) <span class="va">problem</span>.<span class="va">M</span>.<span class="va">proj</span>(<span class="va">x</span><span class="op">,</span> <span class="va">A</span><span class="op">*</span><span class="va">u</span> <span class="op">-</span> (<span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span>)<span class="op">*</span><span class="va">u</span>)<span class="op">;</span> <span class="co">% optional</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some comments:</p>
<ul>
<li>Again, it is fine to omit <code>hess</code>, but try not to omit <code>grad</code> (see earlier comments).</li>
<li>The input to <code>grad</code> is a point <span class="math inline">\(x\)</span>. The output is a <em>tangent vector</em> at <span class="math inline">\(x\)</span>, corresponding to <span class="math inline">\(\grad f(x)\)</span>.</li>
<li>The inputs to <code>hess</code> are a point <span class="math inline">\(x\)</span> and a <em>tangent vector</em> <span class="math inline">\(u\)</span> at <span class="math inline">\(x\)</span>. The output is a <em>tangent vector</em> at <span class="math inline">\(x\)</span>, corresponding to <span class="math inline">\(\Hess f(x)[u]\)</span>.</li>
</ul>
</section>
<section id="using-automatic-differentiation" class="level3">
<h3 class="anchored" data-anchor-id="using-automatic-differentiation">Using automatic differentiation</h3>
<p>Automatic differentiation (AD) is a means to obtain gradients and Hessians automatically, without the need to derive and implement formulas for them. This is usually slower than (good) hand-written code, but it can drastically reduce coding time, making it great (at least) for prototyping.</p>
<p>Manopt 7.0 added support for AD by building on Matlab’s <a href="https://ch.mathworks.com/products/deep-learning.html">Deep Learning Toolbox</a>. To use it, simply define the cost and call <code>manoptAD</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span> <span class="op">=</span> <span class="va">manoptAD</span>(<span class="va">problem</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If it works, then the problem structure now includes access to the gradient and Hessian. If it does not work, check the following:</p>
<ul>
<li>Do you have the Deep Learning Toolbox? Type <code>help dlarray</code>.</li>
<li>Is your Matlab version 2019 or later? Type <code>version</code>.</li>
<li>Is your Manopt version 7.0 or later? Type <code>manopt_version</code>.</li>
<li>Was there an error message? AD does not work for all functions. Check out:
<ul>
<li>The list of <a href="https://ch.mathworks.com/help/deeplearning/ug/list-of-functions-with-dlarray-support.html">dlarray supported functions</a>, and</li>
<li>The docs for AD in Manopt, specifically: <code>help manoptAD</code> and <code>help manoptADhelp</code>.</li>
</ul></li>
<li>Keep in mind that <code>dlarray</code> support also depends on your versions of Matlab and the DL toolbox (e.g., support for AD with complex numbers was added in Matlab R2021b).</li>
<li>If a function you need is not supported (e.g., <code>diag</code>), see <code>help manoptADhelp</code> for a possible replacement (e.g., <code>cdiag</code>), or try to replace it with a direct implementation (e.g., <code>A(1:size(A,1)+1:end).'</code>).</li>
</ul>
<p><a href="https://scholar.google.com/citations?user=g_MNvxwAAAAJ&amp;hl=en">Xiaowen Jiang</a> implemented <code>manoptAD</code> (and the system behind it) during an internship in 2021.</p>
</section>
<section id="fewer-redundant-computations-with-costgrad" class="level3">
<h3 class="anchored" data-anchor-id="fewer-redundant-computations-with-costgrad">Fewer redundant computations with <code>costgrad</code></h3>
<p>Computing the gradient at <span class="math inline">\(x\)</span> often requires going through some of the computations that are also necessary to compute <span class="math inline">\(f(x).\)</span> In our example, both <span class="math inline">\(f(x) = \frac{1}{2}x^\top Ax\)</span> and <span class="math inline">\(\grad f(x) = Ax - (x^\top Ax)x\)</span> require computing <span class="math inline">\(Ax\)</span>.</p>
<p>Since solvers tend to query both <span class="math inline">\(f\)</span> and its gradient at the same point <span class="math inline">\(x\)</span>, it is beneficial to offer solvers the option to query both at the same time. You can do so with the field <code>costgrad</code>, as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">costgrad</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="va">mycostgrad</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span>)<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> [<span class="va">f</span><span class="op">,</span> <span class="va">g</span>] <span class="op">=</span> <span class="va">mycostgrad</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">Ax</span> <span class="op">=</span> <span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span> <span class="co">% this product is computed only once</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">f</span> <span class="op">=</span> <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">Ax</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="va">nargout</span> <span class="op">==</span> <span class="fl">2</span> <span class="co">% compute gradient only if requested</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">g</span> <span class="op">=</span> <span class="va">Ax</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">f</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The input of <code>costgrad</code> is a point <span class="math inline">\(x\)</span>. The outputs are the cost and (if requested) the <em>Riemannian</em> gradient at <span class="math inline">\(x\)</span>. If you prefer to define the <em>Euclidean</em> gradient (as we often do) but still want to avoid redundant computations, read on.</p>
<p>We might also want to provide the Riemannian Hessian with</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">hess</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span>) <span class="va">problem</span>.<span class="va">M</span>.<span class="va">proj</span>(<span class="va">x</span><span class="op">,</span> <span class="va">A</span><span class="op">*</span><span class="va">u</span> <span class="op">-</span> (<span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span>)<span class="op">*</span><span class="va">u</span>)<span class="op">;</span> <span class="co">% optional</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, now we see that the product <code>A*x</code> could also be reused there. The next section provides a more sophisticated approach which gives users full control over which computations to cache for reuse.</p>
</section>
<section id="using-the-store-caching-system" class="level3">
<h3 class="anchored" data-anchor-id="using-the-store-caching-system">Using the <code>store</code> caching system</h3>
<p>Computing anything at a point <span class="math inline">\(x\)</span> (e.g., <span class="math inline">\(f(x)\)</span>) may produce intermediate results that could be reused for other computations at <span class="math inline">\(x\)</span> (e.g., the gradient). It may be beneficial to cache (that is, to store) some of those intermediate calculations.</p>
<p>For that purpose, within the run of a solver, Manopt manages a database of <code>store</code> structures, with a class called <a href="https://github.com/NicolasBoumal/manopt/blob/master/manopt/core/StoreDB.m">StoreDB</a>. For each visited point <span class="math inline">\(x\)</span>, a <code>store</code> structure is created in that database. StoreDB labels the points visited on the manifold with a <code>key</code> (an integer). This <code>key</code> uniquely identifies <span class="math inline">\(x\)</span>: that is how the toolbox links <span class="math inline">\(x\)</span> with its associated <code>store</code>. Only the stores pertaining to the most recently used points are kept in memory. </p>
<p>Whenever a solver calls, say, the <code>cost</code> function at some point <span class="math inline">\(x\)</span>, the toolbox searches for a <code>store</code> structure associated to that <span class="math inline">\(x\)</span> in the database (using its <code>key</code>). If there is one and if <code>problem.cost</code> (for example) admits <code>store</code> as an input and as an output, the <code>store</code> is passed to the <code>cost</code> function. The <code>cost</code> function then performs its duty and gets to modify the <code>store</code> structure at will.</p>
<p>The next time a function is called at the <em>same</em> point <span class="math inline">\(x\)</span> (say, <code>problem.egrad</code>), the <em>same</em> <code>store</code> structure is passed along, possibly modified, and stored again.</p>
<p>As soon as the solver goes on to explore a <em>new</em> point <span class="math inline">\(x'\)</span>, a <em>different</em> <code>store</code> structure is created and maintained in the same way. If the solver later decides to return to the previous <span class="math inline">\(x\)</span>, we get access to that earlier <code>store</code> again (unless it was purged from memory).</p>
<p>For our running example, the code below shows how we can use the caching system to implement the cost, gradient and Hessian without redundant computations. The principle is this:</p>
<ul>
<li>Write a function <code>prepare</code> which computes all the things you want to cache at a given point.</li>
<li>Have <code>cost</code>, <code>egrad</code>, <code>ehess</code> etc. call <code>prepare</code> before they proceed with their own computations.</li>
</ul>
<p>The code is given in two versions (use the tabs to switch):</p>
<ul>
<li>One version nests the functions <code>prepare</code>, <code>cost</code>, <code>egrad</code> and <code>ehess</code> within a top function (with a common scope).</li>
<li>One version allows for those functions to be defined in independent scopes.</li>
</ul>
<p>You may prefer one or the other depending on your use case.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">As a function with nested functions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">As a script with function handles</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="sourceCode" id="cb7"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">x</span> <span class="op">=</span> <span class="va">rayleighmin</span>(<span class="va">A</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">problem</span>.<span class="va">M</span> <span class="op">=</span> <span class="va">spherefactory</span>(<span class="va">size</span>(<span class="va">A</span><span class="op">,</span> <span class="fl">1</span>))<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span><span class="va">cost</span><span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">problem</span>.<span class="va">egrad</span> <span class="op">=</span> <span class="op">@</span><span class="va">egrad</span><span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">problem</span>.<span class="va">ehess</span> <span class="op">=</span> <span class="op">@</span><span class="va">ehess</span><span class="op">;</span> <span class="co">% optional</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">x</span> <span class="op">=</span> <span class="va">trustregions</span>(<span class="va">problem</span>)<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">% The functions below are nested:</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">% they can see the matrix A from the top scope.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">~</span><span class="va">isfield</span>(<span class="va">store</span><span class="op">,</span> <span class="ss">'Ax'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">store</span>.<span class="va">Ax</span> <span class="op">=</span> <span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> [<span class="va">f</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">cost</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">Ax</span> <span class="op">=</span> <span class="va">store</span>.<span class="va">Ax</span><span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">f</span> <span class="op">=</span> <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">Ax</span><span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> [<span class="va">g</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">egrad</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">Ax</span> <span class="op">=</span> <span class="va">store</span>.<span class="va">Ax</span><span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">g</span> <span class="op">=</span> <span class="va">Ax</span><span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> [<span class="va">h</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">ehess</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">% In general we would call prepare()</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">% here too, but for this example the</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">% Hessian is so simple that we don't</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">% need to.</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">% store = prepare(x, store);</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">h</span> <span class="op">=</span> <span class="va">A</span><span class="op">*</span><span class="va">u</span><span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="sourceCode" id="cb8"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span> <span class="va">clf</span><span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="va">n</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> <span class="va">randsym</span>(<span class="va">n</span>)<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">M</span> <span class="op">=</span> <span class="va">spherefactory</span>(<span class="va">n</span>)<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>) <span class="va">cost</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">egrad</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">store</span>) <span class="va">egrad</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">ehess</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span><span class="op">,</span> <span class="va">store</span>) <span class="va">ehess</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">u</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span> <span class="co">% optional</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="va">x</span> <span class="op">=</span> <span class="va">trustregions</span>(<span class="va">problem</span>)<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">% The functions below appear at the end of the script</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">% (they could also be defined in separate files).</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">% They do not see A, so they need to receive it as an input.</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">% The function handles above are created in a part of the</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">% script that can see A.</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">~</span><span class="va">isfield</span>(<span class="va">store</span><span class="op">,</span> <span class="ss">'Ax'</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">store</span>.<span class="va">Ax</span> <span class="op">=</span> <span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> [<span class="va">f</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">cost</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="va">Ax</span> <span class="op">=</span> <span class="va">store</span>.<span class="va">Ax</span><span class="op">;</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="va">f</span> <span class="op">=</span> <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">Ax</span><span class="op">;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> [<span class="va">g</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">egrad</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="va">store</span> <span class="op">=</span> <span class="va">prepare</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">store</span>)<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">Ax</span> <span class="op">=</span> <span class="va">store</span>.<span class="va">Ax</span><span class="op">;</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="va">g</span> <span class="op">=</span> <span class="va">Ax</span><span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> [<span class="va">h</span><span class="op">,</span> <span class="va">store</span>] <span class="op">=</span> <span class="va">ehess</span>(<span class="va">A</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">u</span><span class="op">,</span> <span class="va">store</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">% In general we would call prepare()</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">% here too, but for this example the</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Hessian is so simple that we don't</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">% need to.</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">% store = prepare(A, x, store);</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="va">h</span> <span class="op">=</span> <span class="va">A</span><span class="op">*</span><span class="va">u</span><span class="op">;</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>It is instructive to execute such code with <a href="https://blogs.mathworks.com/community/2010/02/01/speeding-up-your-program-through-profiling/">the profiler</a> activated and to look at how many times each line of code is executed. You should find that the matrix-vector products <span class="math inline">\(Ax\)</span> (computed only in <code>prepare</code>) are executed exactly as often as they should be. You can use <a href="./tools.html#counters-to-track-computations">Manopt counters</a> to track these products and more.</p>
<p>The store structure also includes a field <code>store.shared</code>. The contents of that field are shared among all points the solver visited so far.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Cache reusable computations, not end results
</div>
</div>
<div class="callout-body-container callout-body">
<p>Manopt automatically caches the value and the gradient of <span class="math inline">\(f\)</span> (both Euclidean and Riemannian) at each queried point <span class="math inline">\(x\)</span>. There is no need to cache those manually. Rather, use the <code>store</code> to cache the most expensive (and reusable) intermediate computations. </p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caching and the Hessian
</div>
</div>
<div class="callout-body-container callout-body">
<p>Each <code>store</code> is associated to a point <span class="math inline">\(x\)</span>. Thus, calls to <code>ehess(x, u, store)</code>and <code>ehess(x, v, store)</code> with the same <code>x</code> and two different tangent vectors <code>u</code>, <code>v</code> receive access to the same <code>store</code>. Therefore, only cache quantities that depend on <code>x</code>, not on <code>u</code>.</p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Lifespan of the cache
</div>
</div>
<div class="callout-body-container callout-body">
<p>Solvers take care of deleting older information when it is no longer relevant. This should be good enough, but you can also cap the maximum number of <code>store</code> structures kept in memory with <code>options.storedepth</code>.</p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caching and <code>statsfun</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>store</code> structure is readable (but not writable) by <a href="./solvers.html#statsfun-option-for-recording-info-at-each-iteration"><code>options.statsfun</code></a>. The <code>store.shared</code> mechanism was originally used together with <code>statsfun</code> to keep track of function calls. As of Manopt 5.0, it is much better to use <a href="./tools.html#counters-to-track-computations">Manopt counters</a> for this purpose.</p>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
StoreDB and <code>key</code> (for solver developers and advanced users; click to expand)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>When you have access to <code>storedb</code> and a <code>key</code> associated to <span class="math inline">\(x\)</span> rather than to a specific store, the store of <span class="math inline">\(x\)</span> can be obtained as <code>store = storedb.getStore(key)</code>. Put the modified <code>store</code> back into the database with <code>storedb.set(store, key)</code>.</p>
<p>Access the shared memory directly as <code>storedb.shared</code>, <em>not</em> via <code>store.shared</code>. This is important: <code>store</code> might have a <code>store.shared</code> field, but when <code>storedb</code> and <code>key</code> are explicitly used, <code>store.shared</code> will not be populated or read on get/set.</p>
<p>If you are developing a solver and hence are managing the StoreDB object yourself:</p>
<p>Each point <span class="math inline">\(x\)</span> should be associated to a <code>key</code>, which is obtained by calling <code>storedb.getNewKey()</code>. From time to time, call <code>storedb.purge()</code> to reduce memory usage. Even better, as soon as you know that the <code>store</code> associated to a certain point is no longer useful, call <code>storedb.remove(key)</code> or <code>storedb.removefirstifdifferent(key1, key2)</code>.</p>
<p>StoreDB is a <a href="https://ch.mathworks.com/help/matlab/matlab_oop/comparing-handle-and-value-classes.html">handle class</a>: its instances are passed by reference. This means that when a <code>storedb</code> object is passed as input to a function, and that function modifies the <code>storedb</code> object, the calling function sees the changes too (without the need to explicitly return the <code>storedb</code> object). Thus, each <code>storedb</code> object exists only once in memory. This makes for cleaner calling patterns and avoids unnecessary copies. This is not the case for the <code>store</code> structures though, which are passed by copy and thus must be returned if the changes are to be permanent.</p>
</div>
</div>
</div>
</section>
</section>
<section id="all-the-ways-to-describe-the-cost" class="level2">
<h2 class="anchored" data-anchor-id="all-the-ways-to-describe-the-cost">All the ways to describe the cost</h2>
<p>Manopt offers many ways to implement <span class="math inline">\(f\)</span>, its gradient, its Hessian and more. This is done by adding function handles as fields in the <code>problem</code> structure. We list them all below.</p>
<p>You can mix and match what you include. If you provide more than one way to compute, say, the gradient, then the toolbox may use any and all of them: it makes an educated guess of which may be most efficient in context. Still, it is good practice to avoid redundancies.</p>
<p>Each function can be provided with one of three different calling patterns, as indicated below. The first one is the simplest and is perfectly fine for prototyping. The other calling patterns give explicit access to Manopt’s caching system, in two flavors:</p>
<ul>
<li>The normal way, with the <code>store</code> structure of the point <code>x</code> as an input and (possibly after modifications) as an output.</li>
<li>The advanced way, with the <code>storedb</code> database and the <code>key</code> associated to <code>x</code>: see the collapsible note above.</li>
</ul>
<table class="table-striped caption-top table">
<caption>Table of all the ways one can describe the cost function in Manopt, including its derivatives, approximations, preconditioners and a line-search hint.</caption>
<thead>
<tr class="header">
<th>Field name (<code>problem."..."</code>)</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>cost</code></td>
<td><span class="math inline">\(f = f(x)\)</span> <br> <code>f = cost(x)</code> <br> <code>[f, store] = cost(x, store)</code> <br> <code>f = cost(x, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>grad</code></td>
<td><span class="math inline">\(g = \grad f(x)\)</span> <br> <code>g = grad(x)</code> <br> <code>[g, store] = grad(x, store)</code> <br> <code>g = grad(x, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>costgrad</code></td>
<td>Computes both <span class="math inline">\(f = f(x)\)</span> and <span class="math inline">\(g = \grad f(x)\)</span>. <br> <code>[f, g] = costgrad(x)</code> <br> <code>[f, g, store] = costgrad(x, store)</code> <br> <code>[f, g] = costgrad(x, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>egrad</code></td>
<td>For submanifolds of a Euclidean space and for quotient spaces with a total space embedded in a Euclidean space, computes <span class="math inline">\(eg = \nabla f(x)\)</span>: the gradient of <span class="math inline">\(f\)</span> “as if” it were defined in that Euclidean space. This is passed to <code>M.egrad2rgrad</code>and is automatically cached for use with <code>ehess</code>. <br> <code>eg = egrad(x)</code> <br> <code>[eg, store] = egrad(x, store)</code> <br> <code>eg = egrad(x, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>partialgrad</code></td>
<td>Assume the cost function <code>problem.cost</code> is a sum of many terms, as <span class="math inline">\(f(x) = \sum_{i=1}^{d} f_i(x)\)</span> where <span class="math inline">\(d\)</span> is specified as <code>problem.ncostterms = d</code>. For a subset <span class="math inline">\(I\)</span> of <span class="math inline">\(1\ldots d\)</span>, <code>partialgrad(x, I)</code> computes the Riemannian gradient of the partial cost function <span class="math inline">\(f_I(x) = \sum_{i \in I} f_i(x)\)</span>. <br> <code>pg = partialgrad(x, I)</code> <br> <code>[pg, store] = partialgrad(x, I, store)</code> <br> <code>pg = partialgrad(x, I, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>partialegrad</code></td>
<td>Same as <code>partialgrad</code> but computes the Euclidean partial gradient. This is automatically transformed into a Riemannian partial gradient by Manopt. <br> <code>peg = partialegrad(x, I)</code> <br> <code>[peg, store] = partialegrad(x, I, store)</code> <br> <code>peg = partialegrad(x, I, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>approxgrad</code></td>
<td>Approximation for the gradient of the cost at <span class="math inline">\(x\)</span>. Solvers asking for the gradient when one is not provided automatically fall back to this approximation. If it is not provided either, a standard finite-difference approximation of the gradient based on the cost is built-in. This is slow because it involves generating an orthonormal basis of the tangent space at <span class="math inline">\(x\)</span> and computing a finite difference of the cost along each basis vector. This is useful almost exclusively for prototyping. Because of the limited accuracy, it may be necessary to increase <code>options.tolgradnorm</code> when using this feature. See <a href="https://github.com/NicolasBoumal/manopt/tree/master/manopt/solvers/gradientapproximations">/solvers/gradientapproximations</a>. <br> <code>g = approxgrad(x)</code> <br> <code>[g, store] = approxgrad(x, store)</code> <br> <code>g = approxgrad(x, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>subgrad</code></td>
<td>Returns a Riemannian subgradient of the cost function at <span class="math inline">\(x\)</span>, with a tolerance <code>tol</code> which is a nonnegative real number. If you wish to return the minimal norm subgradient (which may help solvers), see <code>smallestinconvexhull</code> on the <a href="./tools.html">tools</a> page. <br> <code>g = subgrad(x, tol)</code> <br> <code>[g, store] = subgrad(x, tol, store)</code> <br> <code>g = subgrad(x, tol, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>diff</code></td>
<td><span class="math inline">\(d = \D f(x)[u]\)</span> defines directional derivatives. If the gradient exists, it can be computed from this too (slowly.) <br> <code>d = diff(x, u)</code> <br> <code>[d, store] = diff(x, u, store)</code> <br> <code>d = diff(x, u, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>hess</code></td>
<td><span class="math inline">\(h = \Hess f(x)[u]\)</span>, where <span class="math inline">\(u\)</span> represents a tangent vector. <br> <code>h = hess(x, u)</code> <br> <code>[h, store] = hess(x, u, store)</code> <br> <code>h = hess(x, u, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>ehess</code></td>
<td>For the same settings as with <code>egrad</code>, this computes <span class="math inline">\(eh = \nabla^2 f(x)[u]\)</span>: the Hessian of <span class="math inline">\(f\)</span> along <span class="math inline">\(u\)</span> “as if” it were defined in the embedding Euclidean space. This is passed to <code>M.ehess2rhess</code> and thus requires the Euclidean gradient to be accessible too (<code>egrad</code>). Input <span class="math inline">\(u\)</span> is a representation of the tangent vector. You may want to call <code>M.tangent2ambient(x, u)</code> to obtain the ambient space equivalent of <span class="math inline">\(u\)</span>. The output <code>eh</code> should be a vector in the ambient space. <br> <code>eh = ehess(x, u)</code> <br> <code>[eh, store] = ehess(x, u, store)</code> <br> <code>eh = ehess(x, u, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>approxhess</code></td>
<td>This can be any mapping from the tangent space at <span class="math inline">\(x\)</span> to itself. Often, one would like for it to be a linear, symmetric operator. Solvers asking for the Hessian when one is not provided automatically fall back to this approximate Hessian. If it is not provided either, a standard finite-difference approximation of the Hessian based on the gradient is built-in. See <a href="https://github.com/NicolasBoumal/manopt/tree/master/manopt/solvers/hessianapproximations">/solvers/hessianapproximations</a>. <br> <code>h = approxhess(x, u)</code> <br> <code>[h, store] = approxhess(x, u, store)</code> <br> <code>h = approxhess(x, u, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>precon</code></td>
<td><span class="math inline">\(v = \operatorname{Prec}(x)[u]\)</span>, where <span class="math inline">\(\operatorname{Prec}(x)\)</span> is a preconditioner for the Hessian <span class="math inline">\(\Hess f(x)\)</span>, that is, <span class="math inline">\(\operatorname{Prec}(x)\)</span> is a symmetric, positive-definite linear operator (w.r.t. the Riemannian metric) on the tangent space at <span class="math inline">\(x\)</span>. Ideally, it is cheap to compute and such that solving a linear system in <span class="math display">\[\operatorname{Prec}^{1/2}(x) \circ \Hess f(x) \circ \operatorname{Prec}^{1/2}(x)\]</span> is easier than without the preconditioner, i.e., it should approximate the inverse of the Hessian. See <a href="https://github.com/NicolasBoumal/manopt/tree/master/manopt/solvers/preconditioners">/solvers/preconditioners</a>. <br> <code>v = precon(x, u)</code> <br> <code>[v, store] = precon(x, u, store)</code> <br> <code>v = precon(x, u, storedb, key)</code></td>
</tr>
<tr class="even">
<td><code>sqrtprecon</code></td>
<td><span class="math inline">\(v = \operatorname{Prec}^{1/2}(x)[u]\)</span>, where <span class="math inline">\(\operatorname{Prec}^{1/2}(x)\)</span> is an (operator) square root of a preconditioner for the Hessian <span class="math inline">\(\Hess f(x)\)</span>, that is, <span class="math inline">\(\operatorname{Prec}^{1/2}(x)\)</span> is a symmetric, positive-definite linear operator (w.r.t. the Riemannian metric) on the tangent space at <span class="math inline">\(x\)</span>, and applying it twice should amount to applying <span class="math inline">\(\operatorname{Prec}(x)\)</span> once. Solvers typically use <code>precon</code> rather than <code>sqrtprecon</code>, but some tools (such as <code>hessianspectrum</code>) can use <code>sqrtprecon</code> to speed up computations. <br> <code>v = sqrtprecon(x, u)</code> <br> <code>[v, store] = sqrtprecon(x, u, store)</code> <br> <code>v = sqrtprecon(x, u, storedb, key)</code></td>
</tr>
<tr class="odd">
<td><code>linesearch</code></td>
<td>Given a point <span class="math inline">\(x\)</span> and a tangent vector <span class="math inline">\(u\)</span> at <span class="math inline">\(x\)</span>, assume <span class="math inline">\(u\)</span> is a descent direction. This means there exists <span class="math inline">\(t &gt; 0\)</span> such that <span class="math inline">\(\phi(t) &lt; \phi(0)\)</span> with <span class="math display">\[\phi(t) = f(\Retr_x(td)).\]</span> Line-search algorithms, which are used by some solvers such as <code>steepestdescent</code> and <code>conjugategradient</code> are designed to (approximately) minimize <span class="math inline">\(\phi\)</span> at each iteration. There are built-in, generic ways of doing this. If you have additional structure in your problem that enables you to take a good guess at what <span class="math inline">\(t\)</span> should be, then you can specify it here, in this function handle. This (very much optional) function should return a positive <span class="math inline">\(t &gt; 0\)</span> such that <span class="math inline">\(t\)</span> is a good guess of where to look for a minimizer of <span class="math inline">\(\phi\)</span>. The line-search algorithm (if it decides to use this information) starts by looking at the step <span class="math inline">\(td\)</span>, and decides to accept it or not based on its internal rules. See the <code>linesearch</code> option on the <a href="./solvers.html">solvers</a> page for details on available line-search algorithms and how to pick one. See <a href="https://github.com/NicolasBoumal/manopt/blob/master/examples/low_rank_matrix_completion.m"><code>low_rank_matrix_completion</code></a> for an example from the literature. <br> <code>t = linesearch(x, u)</code> <br> <code>[t, store] = linesearch(x, u, store)</code> <br> <code>t = linesearch(x, u, storedb, key)</code></td>
</tr>
</tbody>
</table>
</section>
<section id="accessing-the-cost-gradient-and-hessian" class="level2">
<h2 class="anchored" data-anchor-id="accessing-the-cost-gradient-and-hessian">Accessing the cost, gradient and Hessian</h2>
<p>Given a <code>problem</code> structure with a manifold <code>problem.M</code> and some description of the cost function <span class="math inline">\(f\)</span>, Manopt provides access to <span class="math inline">\(f\)</span> and its derivatives with the tools <code>getCost</code>, <code>getGradient</code> and <code>getHessian</code>. Here is an example:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> <span class="va">randsym</span>(<span class="fl">10</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">M</span> <span class="op">=</span> <span class="va">spherefactory</span>(<span class="fl">10</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">cost</span> <span class="op">=</span> <span class="op">@</span>(<span class="va">x</span>) <span class="fl">.5</span><span class="op">*</span><span class="va">x</span><span class="op">'*</span><span class="va">A</span><span class="op">*</span><span class="va">x</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span> <span class="op">=</span> <span class="va">manoptAD</span>(<span class="va">problem</span>)<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">% For illustration, pick a random point on M</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="va">x</span> <span class="op">=</span> <span class="va">problem</span>.<span class="va">M</span>.<span class="va">rand</span>()<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">% Compute f(x)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="va">f</span> <span class="op">=</span> <span class="va">getCost</span>(<span class="va">problem</span><span class="op">,</span> <span class="va">x</span>)<span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">% Compute grad f(x) (Riemannian)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="va">getGradient</span>(<span class="va">problem</span><span class="op">,</span> <span class="va">x</span>)<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">% The Riemannian norm of the gradient is:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">M</span>.<span class="va">norm</span>(<span class="va">x</span><span class="op">,</span> <span class="va">g</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">% Pick a random tangent vector at x</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="va">u</span> <span class="op">=</span> <span class="va">problem</span>.<span class="va">M</span>.<span class="va">randvec</span>(<span class="va">x</span>)<span class="op">;</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">% Compute Hess f(x)[u] (Riemannian)</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="va">Hu</span> <span class="op">=</span> <span class="va">getHessian</span>(<span class="va">problem</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">u</span>)<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">% The Hessian quadratic form &lt;u, Hess f(x)[u]&gt;_x is:</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="va">problem</span>.<span class="va">M</span>.<span class="va">inner</span>(<span class="va">x</span><span class="op">,</span> <span class="va">u</span><span class="op">,</span> <span class="va">Hu</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are more functions of this type: see the <a href="./core.html">core tools</a> page.</p>
<p>All of these tools also accept calls with <code>store</code> and <code>(storedb, key)</code> (from the caching system described above). This is mostly useful inside the code for a solver.</p>
<p>To compute the eigenvalues of the Hessian, check out the tools <code>hessianspectrum</code>, <code>hessianextreme</code> and <code>hessianmatrix</code> on the <a href="./tools.html">tools</a> page.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.manopt\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie preferences -- it helps us to know which pages are read the most</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>