<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of TT_weingarten</title>
  <meta name="keywords" content="TT_weingarten">
  <meta name="description" content="Weingarten map computation for the fixed TT-rank manifold.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">manopt</a> &gt; <a href="#">manifolds</a> &gt; <a href="index.html">ttfixedrank</a> &gt; TT_weingarten.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for manopt\manifolds\ttfixedrank&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>TT_weingarten
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Weingarten map computation for the fixed TT-rank manifold.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function Y = TT_weingarten(V, Z, ind) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Weingarten map computation for the fixed TT-rank manifold.

 NOTE: this manifold requires the use of a modified version of TTeMPS_1.1,
 which is packaced with Manopt and can be found in 
 manopt/manopt/manifolds/ttfixedrank/TTeMPS_1.1
 
 Y = TT_weingarten(V, Z, ind)
 
 This function implements the efficient way of computing the Weingarten
 map for the Riemannian submanifold of fixed TT-rank tensors embedded in
 its natural embedding Euclidean space, as described in the paper:

   Psenka and Boumal,
   Second-order optimization for tensors with fixed tensor-train rank,
   Optimization workshop at NeurIPS 2020.
 
 Y is the output tangent vector, V is a tangent vector (which contains
 needed information of base point X), Z is a tensor (embedding space).
 
 TT_weingarten supports the following formats for Z:
 1) Full
 2) TT-format (any rank)
 3) sparse, with non-zero indices indexed by ind (see fixedTTrankfactory).

 See also: <a href="fixedTTrankfactory.html" class="code" title="function M = fixedTTrankfactory(n, r, ind)">fixedTTrankfactory</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/full.html" class="code" title="function y = full( x )">full</a>	FULL Convert TTeMPS tensor to full array</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>	NORM Norm of a TT/MPS tensor.</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/full.html" class="code" title="function y = full( x )">full</a>	FULL Convert TTeMPS tensor to full array</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/norm.html" class="code" title="function res = norm( x )">norm</a>	NORM Norm of a TT/MPS block-mu tensor.</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/full.html" class="code" title="function Afull = full( A )">full</a>	FULL Convert TTeMPS_op operator to full array</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>	TENSORPROD_TTEMPS Tensor-times-Matrix product.</li><li><a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>	UNFOLD Left/right-unfold a 3D array.</li><li><a href="../../../manopt/tools/qr_unique.html" class="code" title="function [Q, R] = qr_unique(A)">qr_unique</a>	Thin QR factorization ensuring diagonal of R is real, positive if possible.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="fixedTTrankfactory.html" class="code" title="function M = fixedTTrankfactory(n, r, ind)">fixedTTrankfactory</a>	Manifold of tensors of fixed Tensor Train (TT) rank, embedded geometry</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function ZtX = crossTermMatrixRight(k, m, Zp, V)</a></li><li><a href="#_sub2" class="code">function XtZ = crossTermMatrixLeft(k, m, Zp, V)</a></li><li><a href="#_sub3" class="code">function VtZ = crossTermVariational(k, m, Zp, dURm, V)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function Y = TT_weingarten(V, Z, ind)</a>
0002 <span class="comment">% Weingarten map computation for the fixed TT-rank manifold.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% NOTE: this manifold requires the use of a modified version of TTeMPS_1.1,</span>
0005 <span class="comment">% which is packaced with Manopt and can be found in</span>
0006 <span class="comment">% manopt/manopt/manifolds/ttfixedrank/TTeMPS_1.1</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Y = TT_weingarten(V, Z, ind)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% This function implements the efficient way of computing the Weingarten</span>
0011 <span class="comment">% map for the Riemannian submanifold of fixed TT-rank tensors embedded in</span>
0012 <span class="comment">% its natural embedding Euclidean space, as described in the paper:</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   Psenka and Boumal,</span>
0015 <span class="comment">%   Second-order optimization for tensors with fixed tensor-train rank,</span>
0016 <span class="comment">%   Optimization workshop at NeurIPS 2020.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% Y is the output tangent vector, V is a tangent vector (which contains</span>
0019 <span class="comment">% needed information of base point X), Z is a tensor (embedding space).</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% TT_weingarten supports the following formats for Z:</span>
0022 <span class="comment">% 1) Full</span>
0023 <span class="comment">% 2) TT-format (any rank)</span>
0024 <span class="comment">% 3) sparse, with non-zero indices indexed by ind (see fixedTTrankfactory).</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% See also: fixedTTrankfactory</span>
0027 
0028 <span class="comment">% This file is part of Manopt: www.manopt.org.</span>
0029 <span class="comment">% Original author: Michael Psenka, Nov. 24, 2020.</span>
0030 <span class="comment">% Contributors: Nicolas Boumal</span>
0031 <span class="comment">% Change log:</span>
0032 
0033     <span class="comment">% Preliminary tangent vector set-up for Y</span>
0034     d = V.order;
0035     r = V.rank;
0036     n = V.size;
0037     
0038 
0039     Y = V; <span class="comment">% all properties except for dU cores inherited from V</span>
0040     normV = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(V);
0041     V = (1 / normV) * V;
0042     Y.dU = cell(1, d);
0043 
0044 
0045 
0046     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0047     <span class="comment">% Begin calculating variational components</span>
0048     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0049 
0050     <span class="comment">% Pre-calculate all R-components as needed for tangent space conversion</span>
0051     R = cell(1, d-1);
0052     <span class="comment">% Intermediary used to calculate R-terms for re-orthogonalization</span>
0053     Xr = V.U;
0054 
0055     <span class="keyword">for</span> k = d:-1:2
0056 
0057         sz = size(Xr{k});
0058 
0059         <span class="keyword">if</span> length(sz) == 2
0060             sz = [sz, 1]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0061         <span class="keyword">end</span>
0062 
0063         [Q, R{k - 1}] = <a href="../../../manopt/tools/qr_unique.html" class="code" title="function [Q, R] = qr_unique(A)">qr_unique</a>(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Xr{k}, <span class="string">'right'</span>)');
0064         Xr{k} = reshape(Q', [size(Q, 2), sz(2), sz(3)]);
0065 
0066         Xr{k - 1} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Xr{k - 1}, R{k - 1}, 3);
0067     <span class="keyword">end</span>
0068 
0069     <span class="comment">% Calculate V.dU under the original parametrization of tangent space</span>
0070 
0071     dUR = cell(1, d);
0072 
0073     <span class="keyword">for</span> k = 1:(d - 1)
0074         dUR{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{k}, <span class="string">'left'</span>) / R{k}';
0075         dUR{k} = reshape(dUR{k}, [r(k), n(k), r(k + 1)]);
0076     <span class="keyword">end</span>
0077 
0078     dUR{d} = V.dU{d};
0079 
0080     <span class="comment">% Calculate ~X^tV_{\ge k} efficiently</span>
0081     XtVg = cell(1, d);
0082 
0083     XtVg{d} = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{d}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{d}, <span class="string">'right'</span>).';
0084     XtVgTmp = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{d}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{d}, <span class="string">'right'</span>).';
0085 
0086     <span class="keyword">for</span> k = (d - 1):-1:2
0087         tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.V{k}, XtVg{k + 1}', 3);
0088         XtVg{k} = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'right'</span>).';
0089 
0090         tmp2 = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.V{k}, XtVgTmp', 3);
0091         XtVg{k} = XtVg{k} + conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp2, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'right'</span>).';
0092         XtVgTmp = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp2, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'right'</span>).';
0093     <span class="keyword">end</span>
0094 
0095     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CASES FOR TYPE OF EUCLIDEAN GRADIENT Z %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0096 
0097     <span class="keyword">if</span> isa(Z, <span class="string">'TTeMPS'</span>) || isa(Z, <span class="string">'TTeMPS_tangent_orth'</span>)<span class="comment">% Z either TT-tensor or tangent vec</span>
0098 
0099         <span class="keyword">if</span> isa(Z, <span class="string">'TTeMPS_tangent_orth'</span>)
0100             Z = tangent_to_TTeMPS(Z); <span class="comment">% efficient to treat both as TTeMPS case</span>
0101         <span class="keyword">end</span>
0102 
0103         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0104         <span class="comment">%%%%%%%%%%%%%%%               DIAGONAL TERMS                 %%%%%%%%%%%%%%%%%%</span>
0105         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0106 
0107         ZVr = cell(1, d); <span class="comment">% stores values of V_&lt;^T(Z&lt;k&gt;)</span>
0108         Zr = cell(1, d);  <span class="comment">% stores values of X_&lt;^T(Z&lt;k&gt;)</span>
0109         ZVl = cell(1, d); <span class="comment">% stores values of (Z&lt;k&gt;)^T(V_&gt;)</span>
0110         Zl = cell(1, d);  <span class="comment">% stores values of (Z&lt;k&gt;)^T(X_&gt;)</span>
0111 
0112 
0113         ZVr{d}  = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{d}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{d}, <span class="string">'right'</span>).';
0114         XtVgTmp = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{d}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{d},  <span class="string">'right'</span>).';
0115 
0116         <span class="keyword">for</span> k = (d - 1):-1:2
0117             tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{k}, ZVr{k + 1}', 3);
0118             ZVr{k} = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'right'</span>).';
0119 
0120             tmp2 = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{k}, XtVgTmp', 3);
0121             ZVr{k} = ZVr{k} + conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp2, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'right'</span>).';
0122             XtVgTmp = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp2, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'right'</span>).';
0123         <span class="keyword">end</span>
0124 
0125         <span class="keyword">for</span> k=1:d
0126             ZVr{k} = ZVr{k}';
0127         <span class="keyword">end</span>
0128    
0129 
0130         Zr{d} = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{d}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{d}, <span class="string">'right'</span>).';
0131 
0132         <span class="keyword">for</span> k = (d - 1):-1:2
0133             tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.V{k}, Zr{k + 1}', 3);
0134             Zr{k} = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{k}, <span class="string">'right'</span>).';
0135         <span class="keyword">end</span>
0136 
0137         <span class="comment">% Computation of ZVl and Zl</span>
0138 
0139         ZVl{1} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{1}, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{1}, <span class="string">'left'</span>);
0140         Zl{1}  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{1}, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{1}, <span class="string">'left'</span>);
0141 
0142         <span class="keyword">for</span> k = 2:(d - 1)
0143             <span class="comment">% (V_k-1)(U_k)</span>
0144             tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.U{k}, ZVl{k - 1}', 1);
0145             ZVl{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{k}, <span class="string">'left'</span>);
0146             <span class="comment">% + (X_k-1)(dU_k)</span>
0147             tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(dUR{k}, Zl{k - 1}', 1);
0148             ZVl{k} = ZVl{k} + <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{k}, <span class="string">'left'</span>);
0149             <span class="comment">% update Zr to keep up w/ recursive definition</span>
0150             tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.U{k}, Zl{k - 1}', 1);
0151             Zl{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Z.U{k}, <span class="string">'left'</span>);
0152         <span class="keyword">end</span>
0153 
0154         ZZ = cell(1, d); <span class="comment">% final cores for normal (I \otimes X)Z(X^T)</span>
0155         Zv = cell(1, d); <span class="comment">% final cores for (I \otimes X)Z(V^T)</span>
0156         vZ = cell(1, d); <span class="comment">% final cores for (I \otimes V)Z(X^T)</span>
0157 
0158 
0159         <span class="comment">% contract to first core</span>
0160         ZZ{1} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{1}, Zr{2}, 3);
0161         <span class="comment">% contract to inner cores</span>
0162         <span class="keyword">for</span> k = 2:(d - 1)
0163             res = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{k}, Zl{k - 1}, 1);
0164             ZZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(res, Zr{k + 1}, 3);
0165         <span class="keyword">end</span>
0166 
0167         <span class="comment">% contract to last core</span>
0168         ZZ{d} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{d}, Zl{d - 1}, 1);
0169 
0170         Zv{1} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{1}, ZVr{2}, 3);
0171 
0172         <span class="keyword">for</span> k = 2:(d - 1)
0173             res = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{k}, Zl{k - 1}, 1);
0174             Zv{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(res, ZVr{k + 1}, 3);
0175         <span class="keyword">end</span>
0176 
0177         Zv{d} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{d}, Zl{d - 1}, 1);
0178 
0179 
0180         vZ{1} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{1}, Zr{2}, 3);
0181 
0182         <span class="keyword">for</span> k = 2:(d - 1)
0183             res = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{k}, ZVl{k - 1}, 1);
0184             vZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(res, Zr{k + 1}, 3);
0185         <span class="keyword">end</span>
0186 
0187         vZ{d} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(Z.U{d}, ZVl{d - 1}, 1);
0188 
0189         <span class="comment">% Left unfold everything to apply additional operations</span>
0190         <span class="keyword">for</span> k = 1:d
0191             ZZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(ZZ{k}, <span class="string">'left'</span>);
0192             Zv{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Zv{k}, <span class="string">'left'</span>);
0193             vZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(vZ{k}, <span class="string">'left'</span>);
0194         <span class="keyword">end</span>
0195         <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%% TESTING %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0196 
0197 
0198         <span class="comment">% 1st and last cases special, so they're computed outside the loop</span>
0199         UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{1}, <span class="string">'left'</span>);
0200         dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{1}, <span class="string">'left'</span>);
0201 
0202         <span class="comment">% right variational term without (I - UU^T) projection</span>
0203         rightV = (Zv{1} - ZZ{1} * XtVg{2}) / R{1};
0204 
0205         Y.dU{1} = -dUL * UL' * ZZ{1} + rightV - UL * (UL' * rightV);
0206 
0207         <span class="keyword">for</span> k = 2:(d - 1)
0208             UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0209             dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'left'</span>);
0210 
0211             <span class="comment">% right variational term without (I - UU^T) projection</span>
0212             rightV = (Zv{k} - ZZ{k} * XtVg{k + 1}) / R{k};
0213 
0214             Y.dU{k} = vZ{k} - UL * (UL' * vZ{k}) - dUL * UL' * ZZ{k} <span class="keyword">...</span>
0215                        + rightV - UL * (UL' * rightV);
0216         <span class="keyword">end</span>
0217 
0218         Y.dU{d} = vZ{d};
0219 
0220         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0221         <span class="comment">%%%%%%%%%%%%%%%                  CROSS TERMS                 %%%%%%%%%%%%%%%%%%</span>
0222         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0223 
0224         <span class="keyword">for</span> k = 1:(d - 1)
0225             U = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0226             ZZ{k} = ZZ{k} - U * (U' * ZZ{k});
0227             ZZ{k} = reshape(ZZ{k}, [r(k), n(k), r(k + 1)]);
0228         <span class="keyword">end</span>
0229 
0230         ZZ{d} = reshape(ZZ{d}, [r(d), n(d), 1]);
0231 
0232         <span class="comment">% Double loop to represent P_k DP_m, 1 &lt;= k &lt; d</span>
0233         <span class="keyword">for</span> k = 1:(d - 1)
0234 
0235             UL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0236             dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'left'</span>);
0237 
0238             <span class="keyword">for</span> m = 1:(k - 1)
0239                 VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(k, m, ZZ, dUR{m}, V);
0240                 projUVtZ = VtZ - UL * (UL' * VtZ);
0241 
0242                 Y.dU{k} = Y.dU{k} - projUVtZ;
0243             <span class="keyword">end</span>
0244 
0245             <span class="keyword">for</span> m = (k + 1):d
0246                 ZtX = <a href="#_sub1" class="code" title="subfunction ZtX = crossTermMatrixRight(k, m, Zp, V)">crossTermMatrixRight</a>(k + 1, m, ZZ, V);
0247                 Y.dU{k} = Y.dU{k} + dUL * ZtX;
0248             <span class="keyword">end</span>
0249 
0250         <span class="keyword">end</span>
0251 
0252         <span class="comment">% Final terms for k = d</span>
0253         <span class="keyword">for</span> m = 1:(d - 1)
0254             VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(d, m, ZZ, dUR{m}, V);
0255             Y.dU{d} = Y.dU{d} - VtZ;
0256         <span class="keyword">end</span>
0257 
0258         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%FINAL RESHAPE%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0259 
0260         <span class="keyword">for</span> k = 1:d
0261             Y.dU{k} = reshape(Y.dU{k}, [r(k), n(k), r(k + 1)]);
0262         <span class="keyword">end</span>
0263 
0264     <span class="keyword">elseif</span> ~exist(<span class="string">'ind'</span>, <span class="string">'var'</span>)<span class="comment">% Z is a full array</span>
0265 
0266         <span class="comment">%{</span>
0267         Note that you can split up the <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/full.html" class="code" title="function y = full( x )">full</a> expression <span class="keyword">for</span> the Weingarten map in
0268         the following way:
0269 
0270         1) Diagonal terms(P_i DP_i terms, or non - cross terms)
0271         a) This can be split into(left variational) + (right variational),
0272         which correspond to two terms in product rule expansion
0273         2) Cross terms(P_i DP_j, we show mathematically equivalent expression
0274         in companion paper.)
0275         a) This likewise can be split into(i &lt; j) + (i &gt; j)
0276         <span class="comment">%}</span>
0277 
0278         <span class="comment">% Cell that represents the LEFT VARIATIONAL SIDE</span>
0279         Zv = cell(1, d);
0280         <span class="comment">% Cell that represents the RIGHT VARIATIONAL SIDE</span>
0281         vZ = cell(1, d);
0282 
0283         <span class="comment">% Initialization step</span>
0284         Zv{d} = Z(:);
0285         vZ{d} = Z(:);
0286 
0287         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0288         <span class="comment">%%%%%%%%%%%%%%%               DIAGONAL TERMS                 %%%%%%%%%%%%%%%%%%</span>
0289         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0290 
0291         <span class="comment">%%%%%%%%%%%%%%%               LEFT VARIATIONAL               %%%%%%%%%%%%%%%%%%</span>
0292 
0293         <span class="comment">% First, calculate where the right side is the variational matrix</span>
0294         <span class="comment">% Note that the calculation here is split between VR^-1 and XX^tVR^-1</span>
0295         <span class="comment">% in (I - XX^t)VR^{-1} through xx and xx2 terms respectively</span>
0296 
0297         <span class="comment">% (d-1) term done separately to initialize the temp variable handoff</span>
0298         zz = reshape(Z, [prod(n(1:(d - 1))), n(d)]);
0299         xx = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{d}, <span class="string">'right'</span>));
0300         xxTmp = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{d}, <span class="string">'right'</span>)); <span class="comment">% temp var to help calc xx terms</span>
0301         xx2 = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{d}, <span class="string">'right'</span>));
0302 
0303         <span class="comment">% Z-matrix-k-variational, represents the xx calculation for Zv{k}</span>
0304         Zmkv = zz * xx;
0305         vZ{d - 1} = zz * xx2;
0306         Zv{d - 1} = (Zmkv - vZ{d - 1} * XtVg{d}) / R{d - 1};
0307 
0308         <span class="comment">% auxillery term for computing anything with variational matrix</span>
0309         ZZtmp = zz * xxTmp;
0310 
0311         <span class="comment">% Main calcualtion for right size of Zv</span>
0312         <span class="keyword">for</span> k = (d - 2):-1:1
0313             zz = reshape(Zmkv, [prod(n(1:k)), n(k + 1) * r(k + 2)]);
0314             xx = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k + 1}, <span class="string">'right'</span>));
0315             Zmkv = zz * xx;
0316 
0317             zzTmp = reshape(ZZtmp, [prod(n(1:k)), n(k + 1) * r(k + 2)]);
0318             xxTmp = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k + 1}, <span class="string">'right'</span>));
0319             Zmkv = Zmkv + zzTmp * xxTmp;
0320             ZZtmp = zzTmp * xx;
0321 
0322             <span class="comment">% NOTE: vZ is only used here to store these values for later use</span>
0323             <span class="comment">% It stores the standard right side calc for the orthogonal projector</span>
0324             zz2 = reshape(vZ{k + 1}, [prod(n(1:k)), n(k + 1) * r(k + 2)]);
0325             xx2 = transpose(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{k + 1}, <span class="string">'right'</span>));
0326             vZ{k} = zz2 * xx2;
0327 
0328             Zv{k} = (Zmkv - vZ{k} * XtVg{k + 1}) / R{k};
0329         <span class="keyword">end</span>
0330 
0331         <span class="comment">% Standard left side calculations for Zv</span>
0332         <span class="keyword">for</span> k = 2:d
0333 
0334             <span class="keyword">for</span> i = 1:(k - 1)
0335                 Z_i = reshape(Zv{k}, [r(i) * n(i), prod(n(i + 1:k)) * r(k + 1)]);
0336                 X_i = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{i}, <span class="string">'left'</span>);
0337                 Zm = X_i' * Z_i;
0338                 Zv{k} = Zm;
0339             <span class="keyword">end</span>
0340 
0341             Zv{k} = reshape(Zv{k}, [r(k) * n(k), r(k + 1)]);
0342         <span class="keyword">end</span>
0343 
0344         <span class="comment">% Final U core projector mult for Zv</span>
0345         <span class="keyword">for</span> k = 1:(d - 1)
0346             U = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0347             Zv{k} = Zv{k} - U * (U' * Zv{k});
0348         <span class="keyword">end</span>
0349 
0350         <span class="comment">%%%%%%%%%%%%%%%               RIGHT VARIATIONAL               %%%%%%%%%%%%%%%%%%</span>
0351 
0352         <span class="comment">% represents standard projection, also needed as intermediary for this section</span>
0353         ZZ = vZ;
0354         <span class="comment">% Start left side calculation for vZ</span>
0355         <span class="keyword">for</span> k = 2:d
0356 
0357             <span class="comment">% Do first in loop separately to initialize intermediary variable</span>
0358             Z_i = reshape(vZ{k}, [n(1), prod(n(2:k)) * r(k + 1)]);
0359             dU_i = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{1}, <span class="string">'left'</span>);
0360             Zm = dU_i' * Z_i;
0361             vZ{k} = Zm;
0362 
0363             X_i = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{1}, <span class="string">'left'</span>);
0364             ZZ{k} = X_i' * Z_i;
0365 
0366             <span class="keyword">for</span> m = 2:(k - 1)
0367                 Z_i = reshape(vZ{k}, [r(m) * n(m), prod(n(m + 1:k)) * r(k + 1)]);
0368                 X_i = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{m}, <span class="string">'left'</span>);
0369                 Zm = X_i' * Z_i;
0370 
0371                 Z_tmp = reshape(ZZ{k}, [r(m) * prod(n(m)), prod(n(m + 1:k)) * r(k + 1)]);
0372                 dU_i = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{m}, <span class="string">'left'</span>);
0373 
0374                 vZ{k} = Zm + dU_i' * Z_tmp;
0375 
0376                 ZZ{k} = X_i' * Z_tmp;
0377             <span class="keyword">end</span>
0378 
0379             vZ{k} = reshape(vZ{k}, [r(k) * n(k), r(k + 1)]);
0380             ZZ{k} = reshape(ZZ{k}, [r(k) * n(k), r(k + 1)]);
0381         <span class="keyword">end</span>
0382 
0383         <span class="comment">% Final U core projector mult for vZ</span>
0384 
0385         <span class="comment">% 1st core separate since vZ{1} = 0 up until now. Purely for efficiency</span>
0386         U  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{1},  <span class="string">'left'</span>);
0387         dU = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{1}, <span class="string">'left'</span>);
0388         vZ{1} = -dU * U' * ZZ{1};
0389 
0390         <span class="keyword">for</span> k = 2:(d - 1)
0391             U  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k},  <span class="string">'left'</span>);
0392             dU = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{k}, <span class="string">'left'</span>);
0393             vZ{k} = vZ{k} - U * (U' * vZ{k});
0394 
0395             vZ{k} = vZ{k} - dU * U' * ZZ{k};
0396 
0397         <span class="keyword">end</span>
0398 
0399         <span class="keyword">for</span> k = 1:d - 1
0400             Y.dU{k} = Zv{k} + vZ{k};
0401         <span class="keyword">end</span>
0402 
0403         Y.dU{d} = vZ{d};
0404 
0405 
0406         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0407         <span class="comment">%%%%%%%%%%%%%%%                  CROSS TERMS                 %%%%%%%%%%%%%%%%%%</span>
0408         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0409 
0410         <span class="keyword">for</span> k = 1:(d - 1)
0411             <span class="comment">% now only need ZZ as dU cores of normal projection of V</span>
0412             U = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0413             ZZ{k} = ZZ{k} - U * (U' * ZZ{k});
0414             ZZ{k} = reshape(ZZ{k}, [r(k), n(k), r(k + 1)]);
0415         <span class="keyword">end</span>
0416 
0417         ZZ{d} = reshape(ZZ{d}, [r(d), n(d), 1]);
0418 
0419         <span class="comment">% Double loop to represent P_k DP_m, 1 &lt;= k &lt; d</span>
0420         <span class="keyword">for</span> k = 1:(d - 1)
0421 
0422             UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k},  <span class="string">'left'</span>);
0423             dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.dU{k}, <span class="string">'left'</span>);
0424 
0425             <span class="keyword">for</span> m = 1:(k - 1)
0426                 VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(k, m, ZZ, dUR{m}, V);
0427 
0428                 projUVtZ = VtZ - UL * (UL' * VtZ);
0429 
0430                 Y.dU{k} = Y.dU{k} - projUVtZ; 
0431             <span class="keyword">end</span>
0432 
0433             <span class="keyword">for</span> m = (k + 1):d
0434                 ZtX = <a href="#_sub1" class="code" title="subfunction ZtX = crossTermMatrixRight(k, m, Zp, V)">crossTermMatrixRight</a>(k + 1, m, ZZ, V);
0435                 Y.dU{k} = Y.dU{k} + dUL * ZtX;
0436             <span class="keyword">end</span>
0437 
0438         <span class="keyword">end</span>
0439 
0440         <span class="comment">% Final terms for k = d</span>
0441         <span class="keyword">for</span> m = 1:(d - 1)
0442             VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(d, m, ZZ, dUR{m}, V);
0443 
0444             Y.dU{d} = Y.dU{d} - VtZ;
0445         <span class="keyword">end</span>
0446 
0447         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FINAL RESHAPE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0448 
0449         <span class="keyword">for</span> k = 1:d
0450             Y.dU{k} = reshape(Y.dU{k}, [r(k), n(k), r(k + 1)]);
0451         <span class="keyword">end</span>
0452 
0453     <span class="keyword">else</span>
0454         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SPARSE CASE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0455 
0456         <span class="comment">% permuted U, V, and dU cells for the efficient computation in C</span>
0457         CU = cell(1, d);
0458         CV = cell(1, d);
0459         CdUR = cell(1, d);
0460 
0461         <span class="keyword">for</span> k = 1:d
0462             CU{k} = permute(V.U{k}, [1 3 2]);
0463             CV{k} = permute(V.V{k}, [1 3 2]);
0464             CdUR{k} = permute(dUR{k}, [1 3 2]);
0465         <span class="keyword">end</span>
0466 
0467         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0468         <span class="comment">%%%%%%%%%%%%%%%               DIAGONAL TERMS                 %%%%%%%%%%%%%%%%%%</span>
0469         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0470 
0471         [ZZ, vZ, Zv] = weingarten_omega(n, r, CU, CV, CdUR, ind.', Z);
0472 
0473         <span class="keyword">for</span> k = 1:d
0474 
0475             ZZ{k} = reshape(ZZ{k}, [r(k), r(k + 1), n(k)]);
0476             ZZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(permute(ZZ{k}, [1 3 2]), <span class="string">'left'</span>);
0477 
0478             vZ{k} = reshape(vZ{k}, [r(k), r(k + 1), n(k)]);
0479             vZ{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(permute(vZ{k}, [1 3 2]), <span class="string">'left'</span>);
0480 
0481             Zv{k} = reshape(Zv{k}, [r(k), r(k + 1), n(k)]);
0482             Zv{k} = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(permute(Zv{k}, [1 3 2]), <span class="string">'left'</span>);
0483         <span class="keyword">end</span>
0484 
0485 
0486             
0487 
0488         <span class="comment">% 1st and last cases special, so they're computed outside the loop</span>
0489         UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{1}, <span class="string">'left'</span>);
0490         dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{1}, <span class="string">'left'</span>);
0491 
0492         <span class="comment">% right variational term without (I - UU^T) projection</span>
0493         rightV = (Zv{1} - ZZ{1} * XtVg{2}) / R{1};
0494         Y.dU{1} = -dUL * UL' * ZZ{1} + rightV - UL * (UL' * rightV);
0495 
0496         <span class="keyword">for</span> k = 2:(d - 1)
0497             UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0498             dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'left'</span>);
0499 
0500             <span class="comment">% right variational term without (I - UU^T) projection</span>
0501             rightV = (Zv{k} - ZZ{k} * XtVg{k + 1}) / R{k};
0502             Y.dU{k} = vZ{k} - UL * (UL' * vZ{k}) - dUL * UL' * ZZ{k} + rightV - UL * (UL' * rightV);
0503             <span class="comment">% norm(vZ{k} - UL * (UL' * vZ{k}) + (Zv{k} - UL * (UL' * Zv{k})) / R{k}) / norm(V)</span>
0504             <span class="comment">% norm(V)</span>
0505         <span class="keyword">end</span>
0506 
0507 
0508         Y.dU{d} = vZ{d};
0509 
0510 
0511         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0512         <span class="comment">%%%%%%%%%%%%%%%                  CROSS TERMS                 %%%%%%%%%%%%%%%%%%</span>
0513         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0514 
0515         <span class="keyword">for</span> k = 1:(d - 1)
0516             U = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0517             ZZ{k} = ZZ{k} - U * (U' * ZZ{k});
0518             ZZ{k} = reshape(ZZ{k}, [r(k), n(k), r(k + 1)]);
0519         <span class="keyword">end</span>
0520 
0521         ZZ{d} = reshape(ZZ{d}, [r(d), n(d), 1]);
0522 
0523         <span class="comment">% Double loop to represent P_k DP_m, 1 &lt;= k &lt; d</span>
0524         <span class="keyword">for</span> k = 1:(d - 1)
0525 
0526             UL  = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{k}, <span class="string">'left'</span>);
0527             dUL = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dUR{k}, <span class="string">'left'</span>);
0528 
0529             <span class="keyword">for</span> m = 1:(k - 1)
0530                 <span class="comment">% XtZ = crossTermMatrixLeft(k, m, ZZ, V);</span>
0531                 VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(k, m, ZZ, dUR{m}, V);
0532                 projUVtZ = VtZ - UL * (UL' * VtZ);
0533 
0534                 Y.dU{k} = Y.dU{k} - projUVtZ; <span class="comment">%+ dUL * XtZ;</span>
0535 
0536                 <span class="comment">% Y.dU{k} = Y.dU{k} - (projUk * kron(eye(n(k)), Vllk') - dUkL * Xlek') * Zkm;</span>
0537             <span class="keyword">end</span>
0538 
0539             <span class="keyword">for</span> m = (k + 1):d
0540                 ZtX = <a href="#_sub1" class="code" title="subfunction ZtX = crossTermMatrixRight(k, m, Zp, V)">crossTermMatrixRight</a>(k + 1, m, ZZ, V);
0541                 Y.dU{k} = Y.dU{k} + dUL * ZtX;
0542 
0543                 <span class="comment">%         Y.dU{k} = Y.dU{k} + dUkL * Zkm' * Xg{k+1};</span>
0544             <span class="keyword">end</span>
0545 
0546         <span class="keyword">end</span>
0547 
0548         <span class="comment">% Final terms for k = d</span>
0549         <span class="keyword">for</span> m = 1:(d - 1)
0550             VtZ = <a href="#_sub3" class="code" title="subfunction VtZ = crossTermVariational(k, m, Zp, dURm, V)">crossTermVariational</a>(d, m, ZZ, dUR{m}, V);
0551 
0552             Y.dU{d} = Y.dU{d} - VtZ;
0553 
0554             <span class="comment">%     Y.dU{d} = Y.dU{d} - kron(eye(n(d)), Vlld') * Zkm;</span>
0555         <span class="keyword">end</span>
0556 
0557         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%FINAL RESHAPE%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0558 
0559         <span class="keyword">for</span> k = 1:d
0560             Y.dU{k} = reshape(Y.dU{k}, [r(k), n(k), r(k + 1)]);
0561         <span class="keyword">end</span>
0562 
0563         Y = (normV) * Y;
0564     <span class="keyword">end</span>
0565 
0566 <span class="keyword">end</span>
0567 
0568 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0569 <span class="comment">% Helper methods</span>
0570 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0571 
0572 <span class="comment">% Efficient ZtX term for P_k DP_m, m &gt; k</span>
0573 <span class="comment">% Zp here is the projection of Z (just dU cores)</span>
0574 <span class="comment">% V is only passed for access to U and V cores</span>
0575 <a name="_sub1" href="#_subfunctions" class="code">function ZtX = crossTermMatrixRight(k, m, Zp, V)</a>
0576     ZtX = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Zp{m}, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{m}, <span class="string">'right'</span>).';
0577 
0578     <span class="keyword">for</span> p = (m - 1):-1:k
0579         tmp = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.U{p}, (ZtX)', 3);
0580         ZtX = conj(<a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(tmp, <span class="string">'right'</span>)) * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{p}, <span class="string">'right'</span>).';
0581     <span class="keyword">end</span>
0582 
0583 <span class="keyword">end</span>
0584 
0585 <span class="comment">% Efficient XtZ term for P_k DP_m, m &lt; k</span>
0586 <span class="comment">% Zp here is the projection of Z</span>
0587 <span class="comment">% V is only passed for access to U and V cores</span>
0588 <a name="_sub2" href="#_subfunctions" class="code">function XtZ = crossTermMatrixLeft(k, m, Zp, V) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
0589 
0590     XtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.U{m}, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Zp{m}, <span class="string">'left'</span>);
0591 
0592     <span class="keyword">for</span> p = (m + 1):k
0593         XtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.U{p}, (XtZ)', 1);
0594         XtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(XtZ, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{p}, <span class="string">'left'</span>);
0595     <span class="keyword">end</span>
0596 
0597 <span class="keyword">end</span>
0598 
0599 <span class="comment">% Efficient VtZ (more accurately kron(eye(n(k)), V') * Z) term for P_k DP_m, m &lt; k</span>
0600 <span class="comment">% Zp here is the projection of Z, dURm is normally parametrized dU{m}</span>
0601 <span class="comment">% V is only passed for access to U and V cores</span>
0602 <a name="_sub3" href="#_subfunctions" class="code">function VtZ = crossTermVariational(k, m, Zp, dURm, V)</a>
0603 
0604     VtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(dURm, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Zp{m}, <span class="string">'left'</span>);
0605 
0606     <span class="keyword">for</span> p = (m + 1):(k - 1)
0607         VtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.U{p}, (VtZ)', 1);
0608         VtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(VtZ, <span class="string">'left'</span>)' * <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(V.V{p}, <span class="string">'left'</span>);
0609     <span class="keyword">end</span>
0610 
0611     VtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>(V.V{k}, VtZ, 1);
0612     VtZ = <a href="../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(VtZ, <span class="string">'left'</span>);
0613 
0614 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 30-Sep-2022 13:18:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>