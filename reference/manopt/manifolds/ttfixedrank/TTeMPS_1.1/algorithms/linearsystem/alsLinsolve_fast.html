<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of alsLinsolve_fast</title>
  <meta name="keywords" content="alsLinsolve_fast">
  <meta name="description" content="TTeMPS Toolbox.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../../index.html">Home</a> &gt;  <a href="#">manopt</a> &gt; <a href="#">manifolds</a> &gt; <a href="../../../index.html">ttfixedrank</a> &gt; <a href="../../index.html">TTeMPS_1.1</a> &gt; <a href="../index.html">algorithms</a> &gt; <a href="index.html">linearsystem</a> &gt; alsLinsolve_fast.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../../index.html"><img alt="<" border="0" src="../../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for manopt\manifolds\ttfixedrank\TTeMPS_1.1\algorithms\linearsystem&nbsp;<img alt=">" border="0" src="../../../../../../right.png"></a></td></tr></table>-->

<h1>alsLinsolve_fast
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="box"><strong>TTeMPS Toolbox.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="box"><strong>function [X, residuum, cost, times] = alsLinsolve_fast( L, F, X, opts ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">   TTeMPS Toolbox. 
   Michael Steinlechner, 2013-2016
   Questions and contact: michael.steinlechner@epfl.ch
   BSD 2-clause license, see LICENSE.txt</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>	CONTRACT Contraction of two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>	NORM Norm of a TT/MPS tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orth_at.html" class="code" title="function [x, R] = orth_at(x, pos, dir, apply)">orth_at</a>	ORTH_AT Orthogonalize single core.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/norm.html" class="code" title="function res = norm( x )">norm</a>	NORM Norm of a TT/MPS block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/orthogonalize.html" class="code" title="function res = orthogonalize( x )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize TT/MPS Block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>	APPLY Application of TT/MPS operator to a TT/MPS tensor</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/contract.html" class="code" title="function res = contract( A, X, mu )">contract</a>	CONTRACT Contraction of two TT/MPS tensors with inner TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>	APPLY Application of TT/MPS Laplace-like operator to a TT/MPS tensor</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/contract.html" class="code" title="function res = contract( A, X, mu )">contract</a>	CONTRACT Contraction of two TT/MPS tensors with inner TT/MPS Laplace operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/matricize.html" class="code" title="function res = matricize( U, mode )">matricize</a>	MATRICIZE Matricize 3D Matlab array.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorize.html" class="code" title="function res = tensorize( U, mode, d )">tensorize</a>	TENSORIZE Tensorize matrix (inverse matricization).</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>	TENSORPROD_TTEMPS Tensor-times-Matrix product.</li><li><a href="../../../../../../manopt/tools/orthogonalize.html" class="code" title="function [Q, R] = orthogonalize(M, x, A)">orthogonalize</a>	Orthonormalizes a basis of tangent vectors in the Manopt framework.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/examples/linearsystem_compare.html" class="code" title="">linearsystem_compare</a>	Example code for the algorithms described in</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function res = cost_function( L, X, F )</a></li><li><a href="#_sub2" class="code">function res = cost_function_res( X, res )</a></li><li><a href="#_sub3" class="code">function [left, right] = Afun_prepare( A, x, idx )</a></li><li><a href="#_sub4" class="code">function res = Afun( A, U, idx, sz, left, right )</a></li><li><a href="#_sub5" class="code">function res = solve_inner( L0, X, Fi, idx )</a></li><li><a href="#_sub6" class="code">function [B2, V, E] = prepare_precond( L0, X, idx )</a></li><li><a href="#_sub7" class="code">function res = apply_precond( B2, V, E, rhs, sz )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%   TTeMPS Toolbox.</span>
0002 <span class="comment">%   Michael Steinlechner, 2013-2016</span>
0003 <span class="comment">%   Questions and contact: michael.steinlechner@epfl.ch</span>
0004 <span class="comment">%   BSD 2-clause license, see LICENSE.txt</span>
0005 <a name="_sub0" href="#_subfunctions" class="code">function [X, residuum, cost, times] = alsLinsolve_fast( L, F, X, opts )</a>
0006 
0007 t_start = tic();
0008 <span class="comment">% set default opts</span>
0009 <span class="keyword">if</span> ~exist( <span class="string">'opts'</span>, <span class="string">'var'</span>);       opts = struct();       <span class="keyword">end</span>
0010 <span class="keyword">if</span> ~isfield( opts, <span class="string">'nSweeps'</span>);   opts.nSweeps = 4;      <span class="keyword">end</span>
0011 <span class="keyword">if</span> ~isfield( opts, <span class="string">'solver'</span>);    opts.solver = <span class="string">'pcg'</span>;   <span class="keyword">end</span>
0012 
0013 d = X.order;
0014 n = X.size;
0015 
0016 
0017 normF = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(F);
0018 g = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(L, X) - F;
0019 cost = <a href="#_sub2" class="code" title="subfunction res = cost_function_res( X, res )">cost_function_res</a>( X, g );
0020 residuum = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>( g ) / normF;
0021 times = toc(t_start);
0022 
0023 X = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>(X, 1);
0024 <span class="keyword">for</span> sweep = 1:opts.nSweeps
0025     <span class="comment">% ====================================================================</span>
0026     <span class="comment">% LEFT-TO-RIGHT SWEEP</span>
0027     <span class="comment">% ====================================================================</span>
0028     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( [<span class="string">'STARTING SWEEP '</span>, num2str(sweep), <span class="string">' from left to right'</span>] )
0029     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( <span class="string">'==========================================================='</span>)
0030     <span class="keyword">for</span> idx = 1:d-1
0031         <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( [<span class="string">'Current core: '</span>, num2str(idx)] )
0032 
0033         Fi = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( X, F, idx );
0034         sz = [X.rank(idx), X.size(idx), X.rank(idx+1)];
0035         
0036         <span class="keyword">if</span> strcmpi( opts.solver, <span class="string">'direct'</span> )
0037             <span class="comment">% if system very small</span>
0038             Li = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( L, X, idx );
0039             Ui = Li \ Fi(:);
0040             X.U{idx} = reshape( Ui, sz );
0041 
0042         <span class="keyword">elseif</span> strcmpi( opts.solver, <span class="string">'pcg'</span> )
0043 
0044             [left, right] = <a href="#_sub3" class="code" title="subfunction [left, right] = Afun_prepare( A, x, idx )">Afun_prepare</a>( L, X, idx );
0045             [B2, V, E] =  <a href="#_sub6" class="code" title="subfunction [B2, V, E] = prepare_precond( L0, X, idx )">prepare_precond</a>( L.L0, X, idx );
0046 
0047             Ui = pcg( @(y) <a href="#_sub4" class="code" title="subfunction res = Afun( A, U, idx, sz, left, right )">Afun</a>( L, y, idx, sz, left, right), <span class="keyword">...</span>
0048                      Fi(:), <span class="keyword">...</span>
0049                      1e-10, 1000, <span class="keyword">...</span>
0050                      @(y) <a href="#_sub7" class="code" title="subfunction res = apply_precond( B2, V, E, rhs, sz )">apply_precond</a>( B2, V, E, y, sz ), [],<span class="keyword">...</span>
0051                      X.U{idx}(:) ); 
0052 
0053             X.U{idx} = reshape( Ui, sz );
0054 
0055         <span class="keyword">elseif</span> strcmpi( opts.solver, <span class="string">'diag'</span> )
0056             X.U{idx} = <a href="#_sub5" class="code" title="subfunction res = solve_inner( L0, X, Fi, idx )">solve_inner</a>( L.L0, X, Fi, idx );
0057 
0058         <span class="keyword">else</span>
0059             error( <span class="string">'Unknown opts.solver type. Use either ''direct'', ''pcg'' (default) or ''diag''.'</span> )
0060         <span class="keyword">end</span>
0061 
0062         X = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orth_at.html" class="code" title="function [x, R] = orth_at(x, pos, dir, apply)">orth_at</a>( X, idx, <span class="string">'left'</span>, true );
0063         
0064         g = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(L, X) - F;
0065         residuum = [residuum; <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>( g ) / normF];
0066         cost = [cost; <a href="#_sub2" class="code" title="subfunction res = cost_function_res( X, res )">cost_function_res</a>( X, g )];
0067         times = [times; toc(t_start)];
0068     <span class="keyword">end</span>
0069 
0070     <span class="comment">% ====================================================================</span>
0071     <span class="comment">% RIGHT-TO-LEFT</span>
0072     <span class="comment">% ====================================================================</span>
0073     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( <span class="string">'Starting right-to-left half-sweep:'</span>)
0074     <span class="keyword">for</span> idx = d:-1:2
0075         <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( [<span class="string">'Current core: '</span>, num2str(idx)] )
0076 
0077         Fi = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( X, F, idx );
0078         sz = [X.rank(idx), X.size(idx), X.rank(idx+1)];
0079         
0080         <span class="keyword">if</span> strcmpi( opts.solver, <span class="string">'direct'</span> )
0081             <span class="comment">% if system very small</span>
0082             Li = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( L, X, idx );
0083             Ui = Li \ Fi(:);
0084             X.U{idx} = reshape( Ui, sz );
0085 
0086         <span class="keyword">elseif</span> strcmpi( opts.solver, <span class="string">'pcg'</span> )
0087 
0088             [left, right] = <a href="#_sub3" class="code" title="subfunction [left, right] = Afun_prepare( A, x, idx )">Afun_prepare</a>( L, X, idx );
0089             [B2, V, E] =  <a href="#_sub6" class="code" title="subfunction [B2, V, E] = prepare_precond( L0, X, idx )">prepare_precond</a>( L.L0, X, idx );
0090 
0091             Ui = pcg( @(y) <a href="#_sub4" class="code" title="subfunction res = Afun( A, U, idx, sz, left, right )">Afun</a>( L, y, idx, sz, left, right), <span class="keyword">...</span>
0092                      Fi(:), <span class="keyword">...</span>
0093                      1e-10, 1000, <span class="keyword">...</span>
0094                      @(y) <a href="#_sub7" class="code" title="subfunction res = apply_precond( B2, V, E, rhs, sz )">apply_precond</a>( B2, V, E, y, sz ), [],<span class="keyword">...</span>
0095                      X.U{idx}(:) ); 
0096 
0097 
0098 
0099             X.U{idx} = reshape( Ui, sz );
0100 
0101         <span class="keyword">elseif</span> strcmpi( opts.solver, <span class="string">'diag'</span> )
0102             X.U{idx} = <a href="#_sub5" class="code" title="subfunction res = solve_inner( L0, X, Fi, idx )">solve_inner</a>( L.L0, X, Fi, idx );
0103 
0104         <span class="keyword">else</span>
0105             error( <span class="string">'Unknown opts.solver type. Use either ''direct'', ''pcg'' (default) or ''diag''.'</span> )
0106         <span class="keyword">end</span>
0107 
0108 
0109         X = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orth_at.html" class="code" title="function [x, R] = orth_at(x, pos, dir, apply)">orth_at</a>( X, idx, <span class="string">'right'</span>, true );
0110         
0111         g = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(L, X) - F;
0112         residuum = [residuum; <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>( g ) / normF];
0113         cost = [cost; <a href="#_sub2" class="code" title="subfunction res = cost_function_res( X, res )">cost_function_res</a>( X, g )];
0114         times = [times; toc(t_start)];
0115     <span class="keyword">end</span>
0116     
0117 <span class="keyword">end</span>
0118 
0119 
0120 <span class="keyword">end</span>
0121 
0122 <a name="_sub1" href="#_subfunctions" class="code">function res = cost_function( L, X, F )</a>
0123 res = 0.5*<a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(L, X) ) - <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, F );
0124 <span class="keyword">end</span>
0125 
0126 <a name="_sub2" href="#_subfunctions" class="code">function res = cost_function_res( X, res )</a>
0127 res = 0.5*<a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, res );
0128 <span class="keyword">end</span>
0129 
0130 
0131 <a name="_sub3" href="#_subfunctions" class="code">function [left, right] = Afun_prepare( A, x, idx )</a>
0132     y = A.apply(x); 
0133     <span class="keyword">if</span> idx == 1
0134         right = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'RL'</span>, idx+1 );
0135         left = [];
0136     <span class="keyword">elseif</span> idx == x.order
0137         left = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'LR'</span>, idx-1 );
0138         right = [];
0139     <span class="keyword">else</span>
0140         left = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'LR'</span>, idx-1 );
0141         right = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'RL'</span>, idx+1 ); 
0142     <span class="keyword">end</span>
0143 <span class="keyword">end</span>
0144 
0145 <a name="_sub4" href="#_subfunctions" class="code">function res = Afun( A, U, idx, sz, left, right )</a>
0146 
0147     V = reshape( U, sz );
0148     V = A.apply( V, idx );
0149     
0150     <span class="keyword">if</span> idx == 1
0151         tmp = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( V, right, 3 );
0152     <span class="keyword">elseif</span> idx == A.order
0153         tmp = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( V, left, 1 );
0154     <span class="keyword">else</span>
0155         tmp = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( V, right, 3);
0156         tmp = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( tmp, left, 1);
0157     <span class="keyword">end</span>
0158 
0159     res = tmp(:);
0160 <span class="keyword">end</span>
0161 
0162 <span class="comment">%function res = apply_local_precond( A, U, sz, expB)</span>
0163 <span class="comment">%</span>
0164 <span class="comment">%    p = size(U, 2);</span>
0165 <span class="comment">%</span>
0166 <span class="comment">%    x = reshape( U, [sz, p] );</span>
0167 <span class="comment">%    res = zeros( [sz, p] );</span>
0168 <span class="comment">%</span>
0169 <span class="comment">%    for i = 1:size( expB, 1)</span>
0170 <span class="comment">%        tmp = reshape( x, [sz(1), sz(2)*sz(3)*p] );</span>
0171 <span class="comment">%        tmp = reshape( expB{1,i}*tmp, [sz(1), sz(2), sz(3), p] );</span>
0172 <span class="comment">%</span>
0173 <span class="comment">%        tmp = reshape( permute( tmp, [2 1 3 4] ), [sz(2), sz(1)*sz(3)*p] );</span>
0174 <span class="comment">%        tmp = ipermute( reshape( expB{2,i}*tmp, [sz(2), sz(1), sz(3), p] ), [2 1 3 4] );</span>
0175 <span class="comment">%</span>
0176 <span class="comment">%        tmp = reshape( permute( tmp, [3 1 2 4] ), [sz(3), sz(1)*sz(2)*p] );</span>
0177 <span class="comment">%        tmp = ipermute( reshape( expB{3,i}*tmp, [sz(3), sz(1), sz(2), p] ), [3 1 2 4] );</span>
0178 <span class="comment">%</span>
0179 <span class="comment">%        res = res + tmp;</span>
0180 <span class="comment">%    end</span>
0181 <span class="comment">%    res = reshape( res, [prod(sz), p] );</span>
0182 <span class="comment">%</span>
0183 <span class="comment">%end</span>
0184 
0185 <a name="_sub5" href="#_subfunctions" class="code">function res = solve_inner( L0, X, Fi, idx )</a>
0186     n = size(L0, 1);
0187     rl = X.rank(idx);
0188     rr = X.rank(idx+1);
0189 
0190     B1 = zeros( rl );
0191     <span class="comment">% calculate B1 part:</span>
0192     <span class="keyword">for</span> i = 1:idx-1
0193         <span class="comment">% apply L to the i'th core</span>
0194         tmp = X;
0195         tmp.U{i} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( tmp.U{i}, L0, 2 );
0196         B1 = B1 + <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, tmp, <span class="string">'LR'</span>, idx-1);
0197     <span class="keyword">end</span>
0198 
0199     <span class="comment">% calculate B2 part:</span>
0200     B2 = L0;
0201 
0202     B3 = zeros( rr );
0203     <span class="comment">% calculate B3 part:</span>
0204     <span class="keyword">for</span> i = idx+1:X.order
0205         tmp = X;
0206         tmp.U{i} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( tmp.U{i}, L0, 2 );
0207         B3 = B3 + <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, tmp, <span class="string">'RL'</span>, idx+1);
0208     <span class="keyword">end</span>
0209 
0210     [V,E] = eig( kron( eye(rr), B1 ) + kron( B3, eye(rl) ) );
0211     E = diag(E);
0212 
0213     rhs = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/matricize.html" class="code" title="function res = matricize( U, mode )">matricize</a>( Fi, 2 ) * V;
0214     Y = zeros(size(rhs));
0215     <span class="keyword">for</span> i=1:length(E)
0216         Y(:,i) = (B2 + E(i)*speye(n)) \ rhs(:,i);
0217     <span class="keyword">end</span>
0218     res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorize.html" class="code" title="function res = tensorize( U, mode, d )">tensorize</a>( Y*V', 2, [rl, n, rr] );
0219 <span class="keyword">end</span>
0220 
0221 <a name="_sub6" href="#_subfunctions" class="code">function [B2, V, E] = prepare_precond( L0, X, idx )</a>
0222     n = size(L0, 1);
0223     rl = X.rank(idx);
0224     rr = X.rank(idx+1);
0225 
0226     B1 = zeros( rl );
0227     <span class="comment">% calculate B1 part:</span>
0228     <span class="keyword">for</span> i = 1:idx-1
0229         <span class="comment">% apply L to the i'th core</span>
0230         tmp = X;
0231         tmp.U{i} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( tmp.U{i}, L0, 2 );
0232         B1 = B1 + <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, tmp, <span class="string">'LR'</span>, idx-1);
0233     <span class="keyword">end</span>
0234 
0235     <span class="comment">% calculate B2 part:</span>
0236     B2 = L0;
0237 
0238     B3 = zeros( rr );
0239     <span class="comment">% calculate B3 part:</span>
0240     <span class="keyword">for</span> i = idx+1:X.order
0241         tmp = X;
0242         tmp.U{i} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod_ttemps.html" class="code" title="function res = tensorprod_ttemps( U, A, mode, apply_inv )">tensorprod_ttemps</a>( tmp.U{i}, L0, 2 );
0243         B3 = B3 + <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( X, tmp, <span class="string">'RL'</span>, idx+1);
0244     <span class="keyword">end</span>
0245 
0246     [V,E] = eig( kron( eye(rr), B1 ) + kron( B3, eye(rl) ) );
0247     E = diag(E);
0248 <span class="keyword">end</span>
0249 
0250 <a name="_sub7" href="#_subfunctions" class="code">function res = apply_precond( B2, V, E, rhs, sz )</a>
0251     n = size(B2, 1);
0252     rhs = reshape( rhs, sz );
0253     rhs = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/matricize.html" class="code" title="function res = matricize( U, mode )">matricize</a>( rhs, 2 ) * V;
0254     Y = zeros(size(rhs));
0255     <span class="keyword">for</span> i=1:length(E)
0256         Y(:,i) = (B2 + E(i)*speye(n)) \ rhs(:,i);
0257     <span class="keyword">end</span>
0258     res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorize.html" class="code" title="function res = tensorize( U, mode, d )">tensorize</a>( Y*V', 2, sz );
0259     res = res(:);
0260 <span class="keyword">end</span>
0261 
0262 
0263</pre></div>
<hr><address>Generated on Fri 30-Sep-2022 13:18:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>