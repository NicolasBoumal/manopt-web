<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of amen_eigenvalue</title>
  <meta name="keywords" content="amen_eigenvalue">
  <meta name="description" content="AMEN_EIGENVALUE Calculate p smallest eigenvalues of a TTeMPS operator">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../../index.html">Home</a> &gt;  <a href="#">manopt</a> &gt; <a href="#">manifolds</a> &gt; <a href="../../../index.html">ttfixedrank</a> &gt; <a href="../../index.html">TTeMPS_1.1</a> &gt; <a href="../index.html">algorithms</a> &gt; <a href="index.html">eigenvalue</a> &gt; amen_eigenvalue.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../../index.html"><img alt="<" border="0" src="../../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for manopt\manifolds\ttfixedrank\TTeMPS_1.1\algorithms\eigenvalue&nbsp;<img alt=">" border="0" src="../../../../../../right.png"></a></td></tr></table>-->

<h1>amen_eigenvalue
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="box"><strong>AMEN_EIGENVALUE Calculate p smallest eigenvalues of a TTeMPS operator</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="box"><strong>function [X, C, evalue, residuums, micro_res, objective, elapsed_time] = amen_eigenvalue(A, prec, p, rr, opts) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">AMEN_EIGENVALUE Calculate p smallest eigenvalues of a TTeMPS operator

   [X, C, evalue, residuums, micro_res, objective, elapsed_time] = amen_eigenvalue(A, PREC, P, RR, OPTS)
       performs a rank-adaptive AMEn-type optimization scheme to compute the p smallest eigenvalues of A
       using the algorithm described in [1].

   A preconditioner can be given by passing the PREC argument:
       []      no preconditioner used
       PR      with PR of type TTeMPS_op: PR is applied as a preconditioner
       true    exponential sum preconditioner described in [1] (recommended setting)    

   RR defines the starting rank and should usually be set to ones(1,d) where d is the dimensionality.
   
   Specify the wanted options using the OPTS argument. All options have
   default values (denoted in brackets). Hence, you only have to specify those you want 
   to change.
   The OPTS struct is organized as follows: 
       OPTS.maxiter        Maximum number of full sweeps to perform        [3]
       OPTS.maxrank        Maximum rank during the iteration               [40]
       OPTS.maxrankRes     Maximum rank of residual (0 = No limit)         [0]
       OPTS.tol            Tolerance for the shift from one core 
                           to the next                                     [1e-8]
       OPTS.tolOP          Tolerance for truncation of residual            [1e-6]
       OPTS.tolLOBPCG      Tolerance for inner LOBPCG solver               [1e-6]
       OPTS.maxiterLOBPCG  Max. number of iterations for LOBPCG            [2000]
       OPTS.verbose        Show iteration information (true/false)         [true]
       OPTS.precInner      Precondition the LOBPCG (STRONGLY RECOMMENDED!) [true]


   NOTE: To run amen_eigenvalue, Knyazev's implementation of LOBPCG is required. The corresponding
         m-file can be downloaded from 
               http://www.mathworks.com/matlabcentral/fileexchange/48-lobpcg-m

    References: 
    [1] D. Kressner, M. Steinlechner, A. Uschmajew:
        Low-rank tensor methods with subspace correction for symmetric eigenvalue problems
        SIAM J. Sci. Comput., 36(5):A2346-A2368, 2014.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>	CAT concatenation of two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>	CONTRACT Contraction of two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>	NORM Norm of a TT/MPS tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/truncate.html" class="code" title="function x = truncate( x, r )">truncate</a>	TRUNCATE Truncate TTeMPS tensor to prescribed rank.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/norm.html" class="code" title="function res = norm( x )">norm</a>	NORM Norm of a TT/MPS block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/orthogonalize.html" class="code" title="function res = orthogonalize( x )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize TT/MPS Block-mu tensor.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/truncate.html" class="code" title="function x = round( x, r )">truncate</a>	ROUND Approximate TTeMPS tensor within a prescribed tolerance.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>	APPLY Application of TT/MPS operator to a TT/MPS tensor</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/contract.html" class="code" title="function res = contract( A, X, mu )">contract</a>	CONTRACT Contraction of two TT/MPS tensors with inner TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>	APPLY Application of TT/MPS Laplace-like operator to a TT/MPS tensor</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/constr_precond_inner.html" class="code" title="function expB = constr_precond_inner( A, X, mu )">constr_precond_inner</a>	TTeMPS Toolbox.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/contract.html" class="code" title="function res = contract( A, X, mu )">contract</a>	CONTRACT Contraction of two TT/MPS tensors with inner TT/MPS Laplace operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/disp.html" class="code" title="function disp( x, name )">disp</a>	DISP Display TT/MPS operator.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/TTeMPS_rand.html" class="code" title="function x = TTeMPS_rand(r, n)">TTeMPS_rand</a>	TTEMPS_RAND Create random TTeMPS tensor</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>	TENSORPROD Tensor-times-Matrix product.</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/trunc_singular.html" class="code" title="function s = trunc_singular(s, tol, relative, maxrank)">trunc_singular</a>	REL_TRUNC_SINGULAR Helper routine to truncate singular values</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>	UNFOLD Left/right-unfold a 3D array.</li><li><a href="../../../../../../manopt/tools/orthogonalize.html" class="code" title="function [Q, R] = orthogonalize(M, x, A)">orthogonalize</a>	Orthonormalizes a basis of tangent vectors in the Manopt framework.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/examples/ex_henon_3_hermite.html" class="code" title="">ex_henon_3_hermite</a>	Example for the algorithms described in</li><li><a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/examples/ex_newton_1.html" class="code" title="">ex_newton_1</a>	Example for the algorithms described in</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [left, right] = Afun_prepare( A, x, idx )</a></li><li><a href="#_sub2" class="code">function res = Afun_block_optim( A, U, sz, left, right, mu )</a></li><li><a href="#_sub3" class="code">function res = apply_local_precond( U, sz, expB)</a></li><li><a href="#_sub4" class="code">function res = apply_global_precond( x, res_sz, expB)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [X, C, evalue, residuums, micro_res, objective, elapsed_time] = amen_eigenvalue(A, prec, p, rr, opts)</a>
0002     <span class="comment">%AMEN_EIGENVALUE Calculate p smallest eigenvalues of a TTeMPS operator</span>
0003     <span class="comment">%</span>
0004     <span class="comment">%   [X, C, evalue, residuums, micro_res, objective, elapsed_time] = amen_eigenvalue(A, PREC, P, RR, OPTS)</span>
0005     <span class="comment">%       performs a rank-adaptive AMEn-type optimization scheme to compute the p smallest eigenvalues of A</span>
0006     <span class="comment">%       using the algorithm described in [1].</span>
0007     <span class="comment">%</span>
0008     <span class="comment">%   A preconditioner can be given by passing the PREC argument:</span>
0009     <span class="comment">%       []      no preconditioner used</span>
0010     <span class="comment">%       PR      with PR of type TTeMPS_op: PR is applied as a preconditioner</span>
0011     <span class="comment">%       true    exponential sum preconditioner described in [1] (recommended setting)</span>
0012     <span class="comment">%</span>
0013     <span class="comment">%   RR defines the starting rank and should usually be set to ones(1,d) where d is the dimensionality.</span>
0014     <span class="comment">%</span>
0015     <span class="comment">%   Specify the wanted options using the OPTS argument. All options have</span>
0016     <span class="comment">%   default values (denoted in brackets). Hence, you only have to specify those you want</span>
0017     <span class="comment">%   to change.</span>
0018     <span class="comment">%   The OPTS struct is organized as follows:</span>
0019     <span class="comment">%       OPTS.maxiter        Maximum number of full sweeps to perform        [3]</span>
0020     <span class="comment">%       OPTS.maxrank        Maximum rank during the iteration               [40]</span>
0021     <span class="comment">%       OPTS.maxrankRes     Maximum rank of residual (0 = No limit)         [0]</span>
0022     <span class="comment">%       OPTS.tol            Tolerance for the shift from one core</span>
0023     <span class="comment">%                           to the next                                     [1e-8]</span>
0024     <span class="comment">%       OPTS.tolOP          Tolerance for truncation of residual            [1e-6]</span>
0025     <span class="comment">%       OPTS.tolLOBPCG      Tolerance for inner LOBPCG solver               [1e-6]</span>
0026     <span class="comment">%       OPTS.maxiterLOBPCG  Max. number of iterations for LOBPCG            [2000]</span>
0027     <span class="comment">%       OPTS.verbose        Show iteration information (true/false)         [true]</span>
0028     <span class="comment">%       OPTS.precInner      Precondition the LOBPCG (STRONGLY RECOMMENDED!) [true]</span>
0029     <span class="comment">%</span>
0030     <span class="comment">%</span>
0031     <span class="comment">%   NOTE: To run amen_eigenvalue, Knyazev's implementation of LOBPCG is required. The corresponding</span>
0032     <span class="comment">%         m-file can be downloaded from</span>
0033     <span class="comment">%               http://www.mathworks.com/matlabcentral/fileexchange/48-lobpcg-m</span>
0034     <span class="comment">%</span>
0035     <span class="comment">%    References:</span>
0036     <span class="comment">%    [1] D. Kressner, M. Steinlechner, A. Uschmajew:</span>
0037     <span class="comment">%        Low-rank tensor methods with subspace correction for symmetric eigenvalue problems</span>
0038     <span class="comment">%        SIAM J. Sci. Comput., 36(5):A2346-A2368, 2014.</span>
0039 
0040     <span class="comment">%   TTeMPS Toolbox.</span>
0041     <span class="comment">%   Michael Steinlechner, 2013-2016</span>
0042     <span class="comment">%   Questions and contact: michael.steinlechner@epfl.ch</span>
0043     <span class="comment">%   BSD 2-clause license, see LICENSE.txt</span>
0044 
0045 
0046 nn = A.size_col;
0047 d = A.order;
0048 
0049 <span class="keyword">if</span> ~isempty(prec)
0050     <span class="keyword">if</span> isa(prec,<span class="string">'TTeMPS_op'</span>)
0051         precondition = 1;
0052     <span class="keyword">else</span>
0053         precondition = 2;
0054     <span class="keyword">end</span>
0055 <span class="keyword">else</span>
0056     precondition = 0;
0057 <span class="keyword">end</span>
0058 
0059 <span class="keyword">if</span> ~isfield( opts, <span class="string">'maxiter'</span>);       opts.maxiter = 3;           <span class="keyword">end</span>
0060 <span class="keyword">if</span> ~isfield( opts, <span class="string">'maxrank'</span>);       opts.maxrank = 40;          <span class="keyword">end</span>
0061 <span class="keyword">if</span> ~isfield( opts, <span class="string">'maxrankRes'</span>);    opts.maxrankRes = 0;        <span class="keyword">end</span>
0062 <span class="keyword">if</span> ~isfield( opts, <span class="string">'tol'</span>);           opts.tol = 1e-8;            <span class="keyword">end</span>
0063 <span class="keyword">if</span> ~isfield( opts, <span class="string">'tolOP'</span>);         opts.tolOP = 1e-6;          <span class="keyword">end</span>
0064 <span class="keyword">if</span> ~isfield( opts, <span class="string">'tolLOBPCG'</span>);     opts.tolLOBPCG = 1e-6;      <span class="keyword">end</span>
0065 <span class="keyword">if</span> ~isfield( opts, <span class="string">'maxiterLOBPCG'</span>); opts.maxiterLOBPCG = 2000;  <span class="keyword">end</span>
0066 <span class="keyword">if</span> ~isfield( opts, <span class="string">'verbose'</span>);       opts.verbose = true;        <span class="keyword">end</span>
0067 <span class="keyword">if</span> ~isfield( opts, <span class="string">'precInner'</span>);     opts.precInner = true;     <span class="keyword">end</span>
0068 
0069 <span class="keyword">if</span> p == 1
0070     tolLOBPCGmod = opts.tolLOBPCG;
0071 <span class="keyword">else</span>
0072     tolLOBPCGmod = 0.01;
0073 <span class="keyword">end</span>
0074 
0075 X = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/TTeMPS_rand.html" class="code" title="function x = TTeMPS_rand(r, n)">TTeMPS_rand</a>( rr, nn ); 
0076 <span class="comment">% Left-orthogonalize the tensor:</span>
0077 X = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>( X, X.order );
0078 
0079 C = cell( 1, p );
0080 C{1} = X.U{d};
0081 <span class="keyword">for</span> i = 2:p
0082     C{i} = rand(size(X.U{d}));
0083 <span class="keyword">end</span>
0084 
0085 X.U{d} = rand( X.rank(d), X.size(d), X.rank(d+1), p );
0086 
0087 evalue = [];
0088 residuums = zeros(p,2*opts.maxiter);
0089 micro_res = [];
0090 resi_norm = zeros(p,1);
0091 objective = [];
0092 tic;
0093 elapsed_time = [];
0094 
0095 <span class="keyword">for</span> i = 1:opts.maxiter
0096     
0097     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(sprintf(<span class="string">'Iteration %i:'</span>, i));
0098     <span class="comment">% right-to-left sweep</span>
0099     fprintf(1, <span class="string">'RIGHT-TO-LEFT SWEEP. ---------------\n'</span>)
0100 
0101     <span class="keyword">for</span> mu = d:-1:2
0102         
0103         sz = [X.rank(mu), X.size(mu), X.rank(mu+1)];
0104     
0105         <span class="keyword">if</span> opts.verbose
0106             fprintf(1,<span class="string">'Current core: %i. Current iterate (first eigenvalue): \n'</span>, mu);
0107             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(X);
0108             fprintf(1,<span class="string">'Running LOBPCG: system size %i, tol %g ... '</span>, prod(sz),  max(opts.tolLOBPCG, min( tolLOBPCGmod, sqrt(sum(residuums(:,2*(i-1)+1).^2))/sqrt(p)*tolLOBPCGmod ))) <span class="comment">%opts.tolLOBPCG)</span>
0109         <span class="keyword">else</span>
0110             fprintf(1,<span class="string">'%i  '</span>,mu);
0111         <span class="keyword">end</span>
0112        
0113         [left, right] = <a href="#_sub1" class="code" title="subfunction [left, right] = Afun_prepare( A, x, idx )">Afun_prepare</a>( A, X, mu );
0114         
0115         <span class="keyword">if</span> opts.precInner
0116             <span class="keyword">if</span> prod(sz) &lt; 5*p
0117                 Amat = zeros( prod(sz) );
0118                 <span class="keyword">for</span> i_mat = 1:prod(sz)
0119                     Amat(:,i_mat) = <a href="#_sub2" class="code" title="subfunction res = Afun_block_optim( A, U, sz, left, right, mu )">Afun_block_optim</a>( A, [zeros(i_mat-1,1); 1; zeros(prod(sz)-i_mat,1)], sz, left, right, mu);
0120                 <span class="keyword">end</span>
0121                 [vmat,emat] = eig(Amat);
0122                 [emat,sortind] = sort(diag(emat),<span class="string">'ascend'</span>);
0123                 vmat = vmat(:, sortind);
0124                 L = emat(1:p);
0125                 V = vmat(:, 1:p);
0126                 
0127                 <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">'Reduced system too small for LOBPCG, using eig instead'</span>);
0128                 <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>([<span class="string">'Current Eigenvalue approx: '</span>, num2str( L(1:p)')]);
0129 
0130             <span class="keyword">else</span>
0131                 expB = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/constr_precond_inner.html" class="code" title="function expB = constr_precond_inner( A, X, mu )">constr_precond_inner</a>( A, X, mu );
0132                 [V,L,failureFlag,Lhist ] = lobpcg( rand( prod(sz), p), <span class="keyword">...</span>
0133                                                    @(y) <a href="#_sub2" class="code" title="subfunction res = Afun_block_optim( A, U, sz, left, right, mu )">Afun_block_optim</a>( A, y, sz, left, right, mu), [], <span class="keyword">...</span>
0134                                                    @(y) <a href="#_sub3" class="code" title="subfunction res = apply_local_precond( U, sz, expB)">apply_local_precond</a>( y, sz, expB), <span class="keyword">...</span>
0135                                                    max(opts.tolLOBPCG, min( tolLOBPCGmod, sqrt(sum(residuums(:,2*(i-1)+1).^2))/sqrt(p)*tolLOBPCGmod )), opts.maxiterLOBPCG, 0);
0136                 <span class="keyword">if</span> opts.verbose
0137                     <span class="keyword">if</span> failureFlag
0138                         fprintf(1,<span class="string">'NOT CONVERGED within %i steps!\n'</span>, opts.maxiterLOBPCG)
0139                     <span class="keyword">else</span>
0140                         fprintf(1,<span class="string">'converged after %i steps!\n'</span>, size(Lhist,2));
0141                     <span class="keyword">end</span>
0142                     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>([<span class="string">'Current Eigenvalue approx: '</span>, num2str( L(1:p)')]);
0143                 <span class="keyword">end</span>
0144             <span class="keyword">end</span>
0145         <span class="keyword">else</span>
0146             [V,L,failureFlag,Lhist ] = lobpcg( rand( prod(sz), p), <span class="keyword">...</span>
0147                                                @(y) <a href="#_sub2" class="code" title="subfunction res = Afun_block_optim( A, U, sz, left, right, mu )">Afun_block_optim</a>( A, y, sz, left, right, mu), <span class="keyword">...</span>
0148                                                opts.tolLOBPCG, opts.maxiterLOBPCG, 0);
0149         <span class="keyword">end</span>
0150         
0151         evalue = [evalue, L(1:p)];
0152         objective = [objective, sum(evalue(:,end))];
0153         elapsed_time = [elapsed_time, toc];
0154 
0155         X.U{mu} = reshape( V, [sz, p] );
0156         lamX = X;
0157         lamX.U{mu} = repmat( reshape(L, [1 1 1 p]), [X.rank(mu), X.size(mu), X.rank(mu+1), 1]).*lamX.U{mu};
0158         
0159         res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(A, X) - lamX;
0160         
0161         <span class="keyword">if</span> opts.maxrankRes ~= 0
0162             res_sz = [size(res.U{mu},1), size(res.U{mu},2), size(res.U{mu},3), size(res.U{mu},4)];
0163             res.U{mu} = reshape( permute( res.U{mu}, [1 2 4 3]), [ res_sz(1), res_sz(2)*p, res_sz(3)]);
0164             res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/truncate.html" class="code" title="function x = truncate( x, r )">truncate</a>( res, [1 opts.maxrankRes*ones(1,d-1) 1] );
0165             res.U{mu} = ipermute( reshape( res.U{mu}, [res.rank(mu), res_sz(2), p, res.rank(mu+1)] ), [1 2 4 3]);
0166         <span class="keyword">end</span>
0167 
0168         <span class="comment">% A not so nice way to calculate the residual norm</span>
0169         <span class="keyword">for</span> j = 1:p
0170             tmp = res;
0171             tmp.U{mu} = tmp.U{mu}(:,:,:,j);
0172             resi_norm(j) = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(tmp);
0173             residuums(j,2*(i-1)+1) = resi_norm(j);
0174         <span class="keyword">end</span>
0175         micro_res = [micro_res, resi_norm];
0176         
0177         <span class="keyword">if</span> precondition == 1
0178             res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(prec, res);
0179         <span class="keyword">end</span>
0180         
0181         res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( X, res, [mu-1, mu]);
0182         res_combined = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(res{1},<span class="string">'left'</span>) * reshape(res{2}, [size(res{2},1), size(res{2},2)*size(res{2},3)*p]);
0183 
0184         <span class="keyword">if</span> precondition == 2
0185             expBglobal = constr_precond_outer( A, X, mu-1, mu );
0186             res_size = [size(res{1},1), size(res{1},2), size(res{2},2), size(res{2},3), p];
0187             res_combined = reshape( res_combined, res_size );
0188             res_combined = <a href="#_sub4" class="code" title="subfunction res = apply_global_precond( x, res_sz, expB)">apply_global_precond</a>( res_combined, res_size, expBglobal );
0189         <span class="keyword">end</span>
0190 
0191         res_combined = reshape( res_combined, [size(res{1},1)*size(res{1},2), size(res{2},2)*size(res{2},3)*p]); 
0192 
0193         [uu,ss,vv] = svd( res_combined, <span class="string">'econ'</span>);
0194         s = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/trunc_singular.html" class="code" title="function s = trunc_singular(s, tol, relative, maxrank)">trunc_singular</a>( diag(ss), opts.tolOP, true, opts.maxrankRes );
0195 
0196         res{1} = reshape( uu(:,1:s), [size(res{1},1), size(res{1},2), s]);
0197         res{2} = reshape( ss(1:s,1:s)*vv(:,1:s)', [s, size(res{2},2), size(res{2},3), p]);
0198 
0199         left = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, X.U{mu-1}, res{1} );
0200         V = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, X.U{mu}, res{2});
0201 
0202         tmp = permute( V, [1, 4, 2, 3] );
0203         V = reshape( tmp, [size(tmp,1)*p, size(tmp,3)*size(tmp,4)] );
0204 
0205         [U,S,V] = svd( V, <span class="string">'econ'</span> );
0206         s = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/trunc_singular.html" class="code" title="function s = trunc_singular(s, tol, relative, maxrank)">trunc_singular</a>( diag(S), opts.tol, true, opts.maxrank );
0207 
0208         V = V(:,1:s)';
0209         X.U{mu} = reshape( V, [s, sz(2), sz(3)] );
0210 
0211         W = U(:,1:s)*S(1:s,1:s);
0212         W = reshape( W, [size(tmp,1), p, s]);
0213         W = permute( W, [1, 3, 2]);
0214         <span class="keyword">for</span> k = 1:p
0215             C{k} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>( left, W(:,:,k)', 3);
0216         <span class="keyword">end</span>
0217         X.U{mu-1} = C{1};
0218 
0219         <span class="keyword">if</span> opts.verbose
0220             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( [<span class="string">'Augmented system of size ('</span>, num2str( [sz(1)*p, sz(2)*sz(3)]), <span class="string">'). Cut-off tol: '</span>, num2str(opts.tol) ])
0221             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( sprintf( <span class="string">'Number of SVs: %i. Truncated to: %i =&gt; %g %%'</span>, length(diag(S)), s, s/length(diag(S))*100))
0222             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0223         <span class="keyword">end</span>
0224 
0225     <span class="keyword">end</span>
0226 
0227     <span class="comment">% calculate current residuum</span>
0228 
0229 
0230     fprintf(1, <span class="string">'---------------    finshed sweep.    ---------------\n'</span>) 
0231     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>([<span class="string">'Current residuum: '</span>, num2str(residuums(:,2*(i-1)+1).')])
0232     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0233     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0234     fprintf(1, <span class="string">'--------------- LEFT-TO-RIGHT SWEEP. ---------------\n'</span>) 
0235     <span class="comment">% left-to-right sweep</span>
0236     <span class="keyword">for</span> mu = 1:d-1
0237         sz = [X.rank(mu), X.size(mu), X.rank(mu+1)];
0238 
0239         <span class="keyword">if</span> opts.verbose
0240             fprintf(1,<span class="string">'Current core: %i. Current iterate (first eigenvalue): \n'</span>, mu);
0241             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(X);
0242             fprintf(1,<span class="string">'Running LOBPCG: system size %i, tol %g ... '</span>, prod(sz), max(opts.tolLOBPCG, min( tolLOBPCGmod, sqrt(sum(residuums(:,2*(i-1)+2).^2))/sqrt(p)*tolLOBPCGmod )))
0243         <span class="keyword">else</span>
0244             fprintf(1,<span class="string">'%i  '</span>,mu);
0245         <span class="keyword">end</span>
0246 
0247         [left, right] = <a href="#_sub1" class="code" title="subfunction [left, right] = Afun_prepare( A, x, idx )">Afun_prepare</a>( A, X, mu );
0248         <span class="keyword">if</span> opts.precInner
0249             expB = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/constr_precond_inner.html" class="code" title="function expB = constr_precond_inner( A, X, mu )">constr_precond_inner</a>( A, X, mu );
0250             [U,L,failureFlag,Lhist ] = lobpcg( rand( prod(sz), p), <span class="keyword">...</span>
0251                                                @(y) <a href="#_sub2" class="code" title="subfunction res = Afun_block_optim( A, U, sz, left, right, mu )">Afun_block_optim</a>( A, y, sz, left, right, mu), [], <span class="keyword">...</span>
0252                                                @(y) <a href="#_sub3" class="code" title="subfunction res = apply_local_precond( U, sz, expB)">apply_local_precond</a>( y, sz, expB), <span class="keyword">...</span>
0253                                                max(opts.tolLOBPCG, min( tolLOBPCGmod, sqrt(sum(residuums(:,2*(i-1)+2).^2))/sqrt(p)*tolLOBPCGmod )), <span class="keyword">...</span>
0254                                                opts.maxiterLOBPCG, 0);
0255         <span class="keyword">else</span>
0256             [U,L,failureFlag,Lhist ] = lobpcg( rand( prod(sz), p), <span class="keyword">...</span><span class="comment"> </span>
0257                                                @(y) <a href="#_sub2" class="code" title="subfunction res = Afun_block_optim( A, U, sz, left, right, mu )">Afun_block_optim</a>( A, y, sz, left, right, mu), <span class="keyword">...</span>
0258                                                opts.tolLOBPCG, opts.maxiterLOBPCG, 0);
0259         <span class="keyword">end</span>
0260        
0261         <span class="keyword">if</span> opts.verbose
0262             <span class="keyword">if</span> failureFlag
0263                 fprintf(1,<span class="string">'NOT CONVERGED within %i steps!\n'</span>, opts.maxiterLOBPCG)
0264             <span class="keyword">else</span>
0265                 fprintf(1,<span class="string">'converged after %i steps!\n'</span>, size(Lhist,2));
0266             <span class="keyword">end</span>
0267             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>([<span class="string">'Current Eigenvalue approx: '</span>, num2str( L(1:p)')]);
0268         <span class="keyword">end</span>
0269 
0270         evalue = [evalue, L(1:p)];
0271         objective = [objective, sum(evalue(:,end))];
0272         elapsed_time = [elapsed_time, toc];
0273 
0274         X.U{mu} = reshape( U, [sz, p] );
0275         lamX = X;
0276         lamX.U{mu} = repmat( reshape(L, [1 1 1 p]), [X.rank(mu), X.size(mu), X.rank(mu+1), 1]).*lamX.U{mu};
0277         res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(A, X) - lamX;
0278         
0279         <span class="keyword">if</span> opts.maxrankRes ~= 0
0280             res_sz = [size(res.U{mu},1), size(res.U{mu},2), size(res.U{mu},3), size(res.U{mu},4)];
0281             res.U{mu} = reshape( permute( res.U{mu}, [1 2 4 3]), [ res_sz(1), res_sz(2)*p, res_sz(3)]);
0282             res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/truncate.html" class="code" title="function x = truncate( x, r )">truncate</a>( res, [1 opts.maxrankRes*ones(1,d-1) 1] );
0283             res.U{mu} = ipermute( reshape( res.U{mu}, [ res.rank(mu), res_sz(2), p, res.rank(mu+1)] ), [1 2 4 3]);
0284         <span class="keyword">end</span>
0285         
0286         <span class="comment">% ugly hack to calc the residual</span>
0287         <span class="keyword">for</span> j = 1:p
0288             tmp = res;
0289             tmp.U{mu} = tmp.U{mu}(:,:,:,j);
0290             resi_norm(j) = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(tmp);
0291             residuums(j,2*(i-1)+2) = resi_norm(j);
0292         <span class="keyword">end</span>
0293         micro_res = [micro_res, resi_norm];
0294 
0295         <span class="keyword">if</span> precondition == 1
0296             res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(prec, res);
0297         <span class="keyword">end</span>
0298         res = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/contract.html" class="code" title="function res = contract( x, y, idx )">contract</a>( X, res, [mu, mu+1]);
0299         res_left = permute( res{1}, [1 2 4 3] );
0300         res_left = reshape( res_left, [size(res{1},1)*size(res{1},2)*p, size(res{1},3)]);
0301         res_combined =  res_left * <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(res{2},<span class="string">'right'</span>);
0302 
0303         <span class="keyword">if</span> precondition == 2
0304             expBglobal = constr_precond_outer( A, X, mu, mu+1 );
0305             res_size = [size(res{1},1), size(res{1},2), p, size(res{2},2), size(res{2},3)];
0306             res_combined = reshape( res_combined, res_size );
0307             res_combined = permute( res_combined, [1 2 4 5 3]);  <span class="comment">% move p to back</span>
0308             res_combined = <a href="#_sub4" class="code" title="subfunction res = apply_global_precond( x, res_sz, expB)">apply_global_precond</a>( res_combined, res_size([1 2 4 5 3]), expBglobal );
0309             res_combined = ipermute( res_combined, [1 2 4 5 3]);  <span class="comment">% move p to back</span>
0310         <span class="keyword">end</span>
0311         
0312         res_combined = reshape( res_combined, [size(res{1},1)*size(res{1},2)*p, size(res{2},2)*size(res{2},3)]); 
0313 
0314         [uu,ss,vv] = svd( res_combined, <span class="string">'econ'</span>);
0315         s = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/trunc_singular.html" class="code" title="function s = trunc_singular(s, tol, relative, maxrank)">trunc_singular</a>( diag(ss), opts.tolOP, true, opts.maxrankRes );
0316 
0317         res{1} = reshape( uu(:,1:s)*ss(1:s,1:s), [size(res{1},1), size(res{1},2), p, s]);
0318         res{2} = reshape( vv(:,1:s)', [s, size(res{2},2), size(res{2},3)]);
0319 
0320         right = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, X.U{mu+1}, res{2} );
0321         res{1} = permute( res{1}, [1 2 4 3]);
0322         U = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, X.U{mu}, res{1});
0323 
0324         tmp = permute( U, [1, 2, 4, 3] );
0325         U = reshape( tmp, [size(tmp,1)*size(tmp,2), p*size(tmp,4)] );
0326 
0327         [U,S,V] = svd( U, <span class="string">'econ'</span> );
0328         s = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/trunc_singular.html" class="code" title="function s = trunc_singular(s, tol, relative, maxrank)">trunc_singular</a>( diag(S), opts.tol, true, opts.maxrank );
0329         U = U(:,1:s);
0330         X.U{mu} = reshape( U, [sz(1), sz(2), s] );
0331         W = S(1:s,1:s)*V(:,1:s)';
0332         W = reshape( W, [s, p, size(tmp,4)]);
0333         W = permute( W, [1, 3, 2]);
0334         <span class="keyword">for</span> k = 1:p
0335             C{k} = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>( right, W(:,:,k), 1);
0336         <span class="keyword">end</span>
0337         X.U{mu+1} = C{1};
0338 
0339         <span class="keyword">if</span> opts.verbose
0340             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( [<span class="string">'Augmented system of size ('</span>, num2str( [sz(1)*p, sz(2)*sz(3)]), <span class="string">'). Cut-off tol: '</span>, num2str(opts.tol) ])
0341             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>( sprintf( <span class="string">'Number of SVs: %i. Truncated to: %i =&gt; %g %%'</span>, length(diag(S)), s, s/length(diag(S))*100))
0342             <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0343         <span class="keyword">end</span>
0344 
0345     <span class="keyword">end</span>
0346     <span class="comment">%residuums = [residuums, norm(apply(A,X) - lambda(end)*X)];</span>
0347 
0348     fprintf(1, <span class="string">'---------------    finshed sweep.    ---------------\n'</span>) 
0349     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>([<span class="string">'Current residuum: '</span>, num2str(residuums(:,2*(i-1)+2).')])
0350     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0351     <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/disp.html" class="code" title="function disp( x, name )">disp</a>(<span class="string">' '</span>)
0352 <span class="keyword">end</span>
0353 
0354 evs = zeros(p,1);
0355 <span class="comment">% Evaluate rayleigh quotient for the p TT/MPS tensors</span>
0356 <span class="keyword">for</span> i=1:p
0357     evec = X;
0358     evec.U{d} = C{i};
0359     evs(i) = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( evec, <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/apply.html" class="code" title="function y = apply( A, x, idx )">apply</a>(A, evec));<span class="comment">%/ innerprod( evec, evec);</span>
0360 <span class="keyword">end</span>
0361 evalue = [evalue, evs];
0362 <span class="keyword">end</span>
0363 
0364 <a name="_sub1" href="#_subfunctions" class="code">function [left, right] = Afun_prepare( A, x, idx )</a>
0365     y = A.apply(x); 
0366     <span class="keyword">if</span> idx == 1
0367         right = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'RL'</span>, idx+1 );
0368         left = [];
0369     <span class="keyword">elseif</span> idx == x.order
0370         left = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'LR'</span>, idx-1 );
0371         right = [];
0372     <span class="keyword">else</span>
0373         left = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'LR'</span>, idx-1 );
0374         right = <a href="../../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>( x, y, <span class="string">'RL'</span>, idx+1 ); 
0375     <span class="keyword">end</span>
0376 <span class="keyword">end</span>
0377 
0378 <a name="_sub2" href="#_subfunctions" class="code">function res = Afun_block_optim( A, U, sz, left, right, mu )</a>
0379 
0380 
0381     p = size(U, 2);
0382     
0383     V = reshape( U, [sz, p] );
0384     V = A.apply( V, mu );
0385     
0386     <span class="keyword">if</span> mu == 1
0387         tmp = reshape( permute( V, [3 1 2 4] ), [size(V, 3), sz(1)*sz(2)*p]);
0388         tmp = right * tmp;
0389         tmp = reshape( tmp, [size(right, 1), sz(1), sz(2), p]);
0390         tmp = ipermute( tmp, [3 1 2 4] );
0391     <span class="keyword">elseif</span> mu == A.order
0392         tmp = reshape( V, [size(V,1), sz(2)*sz(3)*p]);
0393         tmp = left * tmp;
0394         tmp = reshape( tmp, [size(left, 1), sz(2), sz(3), p]);
0395     <span class="keyword">else</span>
0396         tmp = reshape( permute( V, [3 1 2 4] ), [size(V, 3), size(V, 1)*sz(2)*p]);
0397         tmp = right * tmp;
0398         tmp = reshape( tmp, [size(right, 1), size(V, 1), sz(2), p]);
0399         tmp = ipermute( tmp, [3 1 2 4] );
0400 
0401         tmp = reshape( tmp, [size(V, 1), sz(2)*sz(3)*p]);
0402         tmp = left * tmp;
0403         tmp = reshape( tmp, [size(left, 1), sz(2), sz(3), p]);
0404 
0405     <span class="keyword">end</span>
0406 
0407     res = reshape( tmp, [prod(sz), p] );
0408 <span class="keyword">end</span>
0409      
0410 
0411 <a name="_sub3" href="#_subfunctions" class="code">function res = apply_local_precond( U, sz, expB)</a>
0412 
0413     p = size(U, 2);
0414 
0415     x = reshape( U, [sz, p] );
0416     res = zeros( [sz, p] );
0417 
0418     <span class="keyword">for</span> i = 1:size( expB, 2)
0419         tmp = reshape( x, [sz(1), sz(2)*sz(3)*p] );
0420         tmp = reshape( expB{1,i}*tmp, [sz(1), sz(2), sz(3), p] );
0421 
0422         tmp = reshape( permute( tmp, [2 1 3 4] ), [sz(2), sz(1)*sz(3)*p] );
0423         tmp = ipermute( reshape( expB{2,i}*tmp, [sz(2), sz(1), sz(3), p] ), [2 1 3 4] );
0424 
0425         tmp = reshape( permute( tmp, [3 1 2 4] ), [sz(3), sz(1)*sz(2)*p] );
0426         tmp = ipermute( reshape( expB{3,i}*tmp, [sz(3), sz(1), sz(2), p] ), [3 1 2 4] );
0427 
0428         res = res + tmp;
0429     <span class="keyword">end</span>
0430     res = reshape( res, [prod(sz), p] );
0431     
0432 <span class="keyword">end</span>
0433 
0434 <a name="_sub4" href="#_subfunctions" class="code">function res = apply_global_precond( x, res_sz, expB)</a>
0435 
0436     res = zeros( res_sz );
0437 
0438     <span class="keyword">for</span> i = 1:size( expB, 2)
0439         tmp = reshape( x, [res_sz(1), prod(res_sz(2:5))] );
0440         tmp = reshape( expB{1,i}*tmp, res_sz );
0441 
0442         tmp = reshape( permute( tmp, [2 1 3 4 5] ), [res_sz(2), res_sz(1)*prod(res_sz(3:5))] );
0443         tmp = ipermute( reshape( expB{2,i}*tmp, [res_sz(2), res_sz(1), res_sz(3:5)] ), [2 1 3 4 5] );
0444 
0445         tmp = reshape( permute( tmp, [3 1 2 4 5] ), [res_sz(3), prod(res_sz([1:2,4:5]))] );
0446         tmp = ipermute( reshape( expB{3,i}*tmp, [res_sz(3), res_sz([1:2,4:5])] ), [3 1 2 4 5] );
0447 
0448         tmp = reshape( permute( tmp, [4 1 2 3 5] ), [res_sz(4), prod(res_sz([1:3,5]))] );
0449         tmp = ipermute( reshape( expB{4,i}*tmp, [res_sz(4), res_sz([1:3,5])] ), [4 1 2 3 5] );
0450 
0451         res = res + tmp;
0452     <span class="keyword">end</span>
0453     
0454 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 05-Sep-2021 17:57:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>