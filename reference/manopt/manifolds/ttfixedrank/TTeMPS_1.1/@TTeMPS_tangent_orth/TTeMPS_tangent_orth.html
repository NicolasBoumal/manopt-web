<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of TTeMPS_tangent_orth</title>
  <meta name="keywords" content="TTeMPS_tangent_orth">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="#">manopt</a> &gt; <a href="#">manifolds</a> &gt; <a href="../../index.html">ttfixedrank</a> &gt; <a href="../index.html">TTeMPS_1.1</a> &gt; <a href="index.html">@TTeMPS_tangent_orth</a> &gt; TTeMPS_tangent_orth.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for manopt\manifolds\ttfixedrank\TTeMPS_1.1\@TTeMPS_tangent_orth&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>TTeMPS_tangent_orth
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/TTeMPS.html" class="code" title="">TTeMPS</a>	</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>	CAT concatenation of two TT/MPS tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/full.html" class="code" title="function y = full( x )">full</a>	FULL Convert TTeMPS tensor to full array</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/gauge_matrices.html" class="code" title="function [xL, xR, G] = gauge_matrices( x )">gauge_matrices</a>	GAUGE_MATRICES Right and left orthogonalization with storage of gauge matrices</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/minus.html" class="code" title="function z = minus( x, y )">minus</a>	MINUS Substraction of two TT/MPS tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/mtimes.html" class="code" title="function x = mtimes( a, x )">mtimes</a>	MINUS Multiplication of TT/MPS tensor by scalar.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>	NORM Norm of a TT/MPS tensor.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize tensor.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/plus.html" class="code" title="function z = plus( x, y )">plus</a>	PLUS Addition of two TT/MPS tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/truncate.html" class="code" title="function x = truncate( x, r )">truncate</a>	TRUNCATE Truncate TTeMPS tensor to prescribed rank.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/full.html" class="code" title="function y = full( x )">full</a>	FULL Convert TTeMPS tensor to full array</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto )">innerprod</a>	INNERPROD Inner product between two TT/MPS tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/minus.html" class="code" title="function z = minus( x, y )">minus</a>	MINUS Substraction of two TT/MPS block-mu tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/mtimes.html" class="code" title="function x = mtimes( a, x )">mtimes</a>	MINUS Multiplication of TT/MPS block tensor by scalar or vector</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/norm.html" class="code" title="function res = norm( x )">norm</a>	NORM Norm of a TT/MPS block-mu tensor.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/orthogonalize.html" class="code" title="function res = orthogonalize( x )">orthogonalize</a>	ORTHOGONALIZE Orthogonalize TT/MPS Block-mu tensor.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/plus.html" class="code" title="function z = plus( x, y )">plus</a>	PLUS Addition of two TT/MPS block-mu tensors.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_block/truncate.html" class="code" title="function x = round( x, r )">truncate</a>	ROUND Approximate TTeMPS tensor within a prescribed tolerance.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/full.html" class="code" title="function Afull = full( A )">full</a>	FULL Convert TTeMPS_op operator to full array</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/mtimes.html" class="code" title="function A = mtimes( B, A )">mtimes</a>	MINUS Multiplication of TT/MPS operator by scalar.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op/plus.html" class="code" title="function z = plus( x, y )">plus</a>	PLUS Addition of two TT/MPS operators.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_op_laplace/mtimes.html" class="code" title="function A = mtimes( B, A )">mtimes</a>	MINUS Multiplication of TT/MPS Laplace operator by scalar.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_tangent/TTeMPS_tangent.html" class="code" title="">TTeMPS_tangent</a>	</li><li><a href="TTeMPS_tangent_orth.html" class="code" title="">TTeMPS_tangent_orth</a>	</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>	TENSORPROD Tensor-times-Matrix product.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>	UNFOLD Left/right-unfold a 3D array.</li><li><a href="../../../../../manopt/tools/orthogonalize.html" class="code" title="function [Q, R] = orthogonalize(M, x, A)">orthogonalize</a>	Orthonormalizes a basis of tangent vectors in the Manopt framework.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="TTeMPS_tangent_orth.html" class="code" title="">TTeMPS_tangent_orth</a>	</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/completion/completion_orth.html" class="code" title="function [xL,cost,test,stats] = completion_orth( A_Omega, Omega, A_Gamma, Gamma, X, opts )">completion_orth</a>	RTTC: Riemannian Tensor Train Completion</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/completion/completion_orth_lambda.html" class="code" title="function [xL,cost,test,stats] = completion_orth_lambda( A_Omega, Omega, A_Gamma, Gamma, X, opts, lambda )">completion_orth_lambda</a>	RTTC: Riemannian Tensor Train Completion</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/RiemannLinsolve.html" class="code" title="function [xR, residuum, gradnorm, cost, times] = RiemannLinsolve( L, F, X0, Lh, Ph, opts )">RiemannLinsolve</a>	Riemannian approx. Newton for linear systems. For more information, we refer to the report</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/RiemannPrecondSteep.html" class="code" title="function [xR, residuum, gradnorm, cost, times] = RiemannPrecondSteep( L, F, X0, Lh, Ph, opts )">RiemannPrecondSteep</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/precond_laplace_noSaddle.html" class="code" title="function [eta] = precond_laplace_noSaddle( L, xi, xL, xR )">precond_laplace_noSaddle</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/precond_laplace_noorth.html" class="code" title="function [eta] = precond_laplace_noorth( L, xi, xL, xR, G )">precond_laplace_noorth</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/precond_laplace_overlapGS.html" class="code" title="function [eta,Yeta] = precond_laplace_overlapGS( L, xi, xL, xR, G, Lapl )">precond_laplace_overlapGS</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/precond_laplace_overlapJacobi.html" class="code" title="function [eta, B1,B3] = precond_laplace_overlapJacobi( L, xi, xL, xR, G, B1, B3 )">precond_laplace_overlapJacobi</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/precond_rankOne.html" class="code" title="function [eta] = precond_rankOne( A, xi, xL, xR  )">precond_rankOne</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/solvePrecond.html" class="code" title="function xi = solvePrecond(L, P, rhs, xL, xR, opts  )">solvePrecond</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/algorithms/linearsystem/solvePrecond_noSaddle.html" class="code" title="function xi = solvePrecond_noSaddle(L, P, rhs, xL, xR, opts, G  )">solvePrecond_noSaddle</a>	TTeMPS Toolbox.</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/install_mex.html" class="code" title="">install_mex</a>	Install helper for mex functions</li><li><a href="../../../../../manopt/manifolds/ttfixedrank/fixedTTrankfactory.html" class="code" title="function M = fixedTTrankfactory(n, r, ind)">fixedTTrankfactory</a>	Manifold of tensors of fixed Tensor Train (TT) rank, embedded geometry</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function Y = TTeMPS_tangent_orth(xL, xR, Z, ind, storedb, key)</a></li><li><a href="#_sub2" class="code">function Zfull = full(Z)</a></li><li><a href="#_sub3" class="code">function res = plus(X, Y)</a></li><li><a href="#_sub4" class="code">function X = minus(X, Y)</a></li><li><a href="#_sub5" class="code">function X = mtimes(a, X)</a></li><li><a href="#_sub6" class="code">function X = uminus(X)</a></li><li><a href="#_sub7" class="code">function Xnew = tangentAdd(Z, t, retract)</a></li><li><a href="#_sub8" class="code">function res = innerprod(Z1, Z2)</a></li><li><a href="#_sub9" class="code">function n = norm(Z)</a></li><li><a href="#_sub10" class="code">function res = at_Omega(Z, ind)</a></li><li><a href="#_sub11" class="code">function res = tangent_to_TTeMPS(Z)</a></li><li><a href="#_sub12" class="code">function z = vectorize_tangent(Z)</a></li><li><a href="#_sub13" class="code">function Z = fill_with_vectorized(Z, z)</a></li><li><a href="#_sub14" class="code">function xi = tangent_orth_to_tangent(Z)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 classdef <a href="TTeMPS_tangent_orth.html" class="code" title="">TTeMPS_tangent_orth</a>
0002     <span class="comment">% TTeMPS_tangent</span>
0003     <span class="comment">%</span>
0004     <span class="comment">%   A MATLAB class for representing and tangent tensors</span>
0005     <span class="comment">%   to the TT/MPS format in the core-by-core orthogonalization</span>
0006     <span class="comment">%   presented in the paper</span>
0007     <span class="comment">%</span>
0008     <span class="comment">%   Michael Steinlechner. Riemannian optimization for high-dimensional tensor completion</span>
0009     <span class="comment">%   Technical report, March 2015. Revised December 2015. To appear in SIAM J. Sci. Comput.</span>
0010     <span class="comment">%</span>
0011 
0012     <span class="comment">%   TTeMPS Toolbox.</span>
0013     <span class="comment">%   Michael Steinlechner, 2013-2016</span>
0014     <span class="comment">%   Questions and contact: michael.steinlechner@epfl.ch</span>
0015     <span class="comment">%   BSD 2-clause license, see LICENSE.txt</span>
0016 
0017     properties (SetAccess = public, GetAccess = public)
0018 
0019         dU
0020         U
0021         V
0022         rank
0023         order
0024         size
0025 
0026     <span class="keyword">end</span>
0027 
0028     methods (Access = public)
0029 
0030         <a name="_sub0" href="#_subfunctions" class="code">function Y = TTeMPS_tangent_orth(xL, xR, Z, ind, storedb, key)</a>
0031             <span class="comment">%TTEMPS_TANGENT projects the d-dimensional array Z into the tangent space at a TT/MPS tensor X.</span>
0032             <span class="comment">%</span>
0033             <span class="comment">%   P = TTEMPS_TANGENT(X) projects the d-dimensional array Z into the tangent space of the</span>
0034             <span class="comment">%   TT-rank-r manifold at a TT/MPS tensor X.</span>
0035             <span class="comment">%</span>
0036 
0037             d = xL.order;
0038             r = xL.rank;
0039             n = xL.size;
0040 
0041             <span class="comment">% additional conditional needed for added code for ManOpt</span>
0042             <span class="keyword">if</span> nargin == 1
0043                 xR = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/orthogonalize.html" class="code" title="function x = orthogonalize( x, pos )">orthogonalize</a>(xL, 1);
0044             <span class="keyword">end</span>
0045 
0046             Y.order = d;
0047             Y.rank = r;
0048             Y.size = n;
0049 
0050             Y.U = xL.U;
0051 
0052             Y.V = xR.U;
0053 
0054             <span class="comment">%%%%%%%%%%%%%%%%%% NEW CODE FOR MANOPT: add constructor for zero vector %%%%%%%%%%%%%%%%%%%%</span>
0055             <span class="comment">% Takes the unused spot nargin == 1      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0056 
0057             <span class="keyword">if</span> nargin == 1
0058                 <span class="comment">% Y.U = xL.U;</span>
0059                 Y.V = xR.U;
0060                 Y.dU = cell(1, d);
0061 
0062                 <span class="keyword">for</span> k = 1:d
0063                     Y.dU{k} = zeros(size(Y.U{k}));
0064                 <span class="keyword">end</span>
0065 
0066             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0067 
0068             <span class="comment">% default constructor which just returns a random unit norm tangent vector</span>
0069             <span class="keyword">elseif</span> nargin == 2
0070                 <span class="comment">% Y.U = xL.U;</span>
0071                 <span class="comment">% Y.V = xR.U;</span>
0072                 Y.dU = cell(1, d);
0073 
0074                 <span class="keyword">for</span> i = 1:d
0075                     Y.dU{i} = randn(size(Y.U{i}));
0076                 <span class="keyword">end</span>
0077 
0078                 Y = <a href="TTeMPS_tangent_orth.html" class="code" title="">TTeMPS_tangent_orth</a>(xL, xR, Y);
0079       
0080                 <span class="comment">% count number of nonzero dU cores</span>
0081                 <span class="comment">% if manifold has positive dimension, num_nonzero &gt; 0</span>
0082                 <span class="comment">% with probability 1</span>
0083                 num_nonzero = 0;
0084                 <span class="keyword">for</span> k = 1:d
0085                     <span class="keyword">if</span> <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(Y.dU{k}(:)) &gt; 1e-14
0086                         num_nonzero = num_nonzero + 1;
0087                     <span class="keyword">end</span>
0088                 <span class="keyword">end</span>
0089 
0090                 <span class="comment">% normalize vec to unit norm based on non-zero dU cores</span>
0091                 <span class="keyword">for</span> k = 1:d
0092                     <span class="keyword">if</span> <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(Y.dU{k}(:)) &gt; 1e-14
0093                         Y.dU{k} = Y.dU{k} / (sqrt(num_nonzero) * <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(Y.dU{k}(:)));
0094                     <span class="keyword">end</span>
0095                 <span class="keyword">end</span>
0096 
0097             <span class="keyword">else</span>
0098 
0099                 <span class="keyword">if</span> ~exist(<span class="string">'ind'</span>, <span class="string">'var'</span>)
0100                     sampled = false;
0101                 <span class="keyword">else</span>
0102                     sampled = true;
0103                 <span class="keyword">end</span>
0104 
0105                 <span class="keyword">if</span> isa(Z, <span class="string">'TTeMPS'</span>)
0106 
0107                     Y.dU = cell(1, d);
0108 
0109                     right = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>(xR, Z, <span class="string">'RL'</span>, 2, true);
0110                     left = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/innerprod.html" class="code" title="function res = innerprod( x, y, dir, upto, storeParts )">innerprod</a>(xL, Z, <span class="string">'LR'</span>, d - 1, true);
0111 
0112                     <span class="comment">% contract to first core</span>
0113                     Y.dU{1} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>(Z.U{1}, right{2}, 3);
0114                     <span class="comment">% contract to inner cores</span>
0115                     <span class="keyword">for</span> i = 2:d - 1
0116                         res = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>(Z.U{i}, left{i - 1}, 1);
0117                         Y.dU{i} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>(res, right{i + 1}, 3);
0118                     <span class="keyword">end</span>
0119 
0120                     <span class="comment">% contract to last core</span>
0121                     Y.dU{d} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>(Z.U{d}, left{d - 1}, 1);
0122 
0123                     <span class="keyword">for</span> i = 1:d - 1
0124                         Y.dU{i} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.dU{i}, <span class="string">'left'</span>);
0125                         U = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.U{i}, <span class="string">'left'</span>);
0126                         Y.dU{i} = Y.dU{i} - U * (U' * Y.dU{i});
0127                         Y.dU{i} = reshape(Y.dU{i}, [r(i), n(i), r(i + 1)]);
0128                     <span class="keyword">end</span>
0129 
0130                 <span class="keyword">elseif</span> isa(Z, <span class="string">'TTeMPS_tangent_orth'</span>)
0131 
0132                     Znew = <a href="#_sub11" class="code" title="subfunction res = tangent_to_TTeMPS(Z)">tangent_to_TTeMPS</a>(Z);
0133                     Y = <a href="TTeMPS_tangent_orth.html" class="code" title="">TTeMPS_tangent_orth</a>(xL, xR, Znew);
0134 
0135                 <span class="keyword">elseif</span> ~sampled <span class="comment">% Z is a full array</span>
0136 
0137                     ZZ = cell(1, d);
0138 
0139                     <span class="comment">% right side</span>
0140                     ZZ{d} = Z(:);
0141 
0142                     <span class="keyword">for</span> i = d - 1:-1:1
0143                         zz = reshape(Z, [prod(n(1:i)), n(i + 1) * r(i + 2)]);
0144                         xx = transpose(<a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.V{i + 1}, <span class="string">'right'</span>));
0145                         Z = zz * xx;
0146                         ZZ{i} = Z;
0147                     <span class="keyword">end</span>
0148 
0149                     <span class="comment">% left side</span>
0150                     <span class="keyword">for</span> k = 2:d
0151 
0152                         <span class="keyword">for</span> i = 1:k - 1
0153                             Z_i = reshape(ZZ{k}, [r(i) * prod(n(i)), prod(n(i + 1:k)) * r(k + 1)]);
0154                             X_i = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.U{i}, <span class="string">'left'</span>);
0155                             Z = X_i' * Z_i;
0156                             ZZ{k} = Z;
0157                         <span class="keyword">end</span>
0158 
0159                         ZZ{k} = reshape(ZZ{k}, [r(k) * n(k), r(k + 1)]);
0160                     <span class="keyword">end</span>
0161 
0162                     Y.dU = cell(1, d);
0163                     <span class="comment">% orth. projection (w/o last core)</span>
0164                     <span class="keyword">for</span> i = 1:d - 1
0165                         U = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.U{i}, <span class="string">'left'</span>);
0166                         ZZ{i} = ZZ{i} - U * (U' * ZZ{i});
0167                         Y.dU{i} = reshape(ZZ{i}, [r(i), n(i), r(i + 1)]);
0168                     <span class="keyword">end</span>
0169 
0170                     Y.dU{d} = reshape(ZZ{d}, [r(d), n(d), r(d + 1)]);
0171 
0172                 <span class="keyword">else</span> <span class="comment">% Z is a sparse array</span>
0173 
0174                     vals = Z;
0175                     CU = cell(1, d);
0176                     CV = cell(1, d);
0177                     Y.dU = cell(1, d);
0178 
0179                     <span class="keyword">for</span> i = 1:d
0180                         CU{i} = permute(Y.U{i}, [1 3 2]);
0181                         CV{i} = permute(Y.V{i}, [1 3 2]);
0182                     <span class="keyword">end</span>
0183 
0184                     res = TTeMPS_tangent_orth.TTeMPS_tangent_orth_omega(n, r, CU, CV, ind.', vals);
0185 
0186                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%% MANOPT ADDED CODE %%%%%%%%%%%%%%%%%%%%%%</span>
0187                     <span class="keyword">if</span> exist(<span class="string">'storedb'</span>, <span class="string">'var'</span>)
0188                     <span class="comment">% store res to be used for efficient Weingarten approx</span>
0189                         store = storedb.getWithShared(key);
0190                         store.inner_dU_ = res;
0191                         storedb.setWithShared(store, key);
0192                     <span class="keyword">end</span>
0193 
0194                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%% END MANOPT ADDED CODE %%%%%%%%%%%%%%%%%%</span>
0195 
0196                     <span class="keyword">for</span> i = 1:d
0197                         res{i} = reshape(res{i}, [r(i), r(i + 1), n(i)]);
0198                         Y.dU{i} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(permute(res{i}, [1 3 2]), <span class="string">'left'</span>);
0199                     <span class="keyword">end</span>
0200 
0201                     <span class="keyword">for</span> i = 1:d - 1
0202                         U = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/unfold.html" class="code" title="function W = unfold( U, dir )">unfold</a>(Y.U{i}, <span class="string">'left'</span>);
0203                         Y.dU{i} = Y.dU{i} - U * (U' * Y.dU{i});
0204                         Y.dU{i} = reshape(Y.dU{i}, [r(i), n(i), r(i + 1)]);
0205                     <span class="keyword">end</span>
0206 
0207                     Y.dU{d} = reshape(Y.dU{d}, [r(d), n(d), r(d + 1)]);
0208 
0209                 <span class="keyword">end</span>
0210 
0211             <span class="keyword">end</span>
0212 
0213         <span class="keyword">end</span>
0214 
0215         <a name="_sub1" href="#_subfunctions" class="code">function Zfull = full(Z)</a>
0216             <span class="comment">%FULL converts tangent tensor to d-dimensional array</span>
0217             <span class="comment">%</span>
0218             <span class="comment">%   ZFULL = full(Z, X) converts the tangent tensor Z given in factorized form</span>
0219             <span class="comment">%   (class TTeMPS_tangent) to a d-dimensional array ZFULL. X is the TTeMPS tensor at</span>
0220             <span class="comment">%   which point the tangent space is taken.</span>
0221             <span class="comment">%</span>
0222 
0223             Zfull = <a href="#_sub11" class="code" title="subfunction res = tangent_to_TTeMPS(Z)">tangent_to_TTeMPS</a>(Z);
0224             Zfull = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/full.html" class="code" title="function y = full( x )">full</a>(Zfull);
0225         <span class="keyword">end</span>
0226 
0227         <a name="_sub2" href="#_subfunctions" class="code">function res = plus(X, Y)</a>
0228             <span class="comment">%PLUS adds two tangent tensors</span>
0229             <span class="comment">%</span>
0230             <span class="comment">%   RES = plus(X, Y) adds two tangent tensors in factorized form. Both tangent tensors</span>
0231             <span class="comment">%   have be elements of the SAME tangent space.</span>
0232             <span class="comment">%</span>
0233 
0234             res = X;
0235             res.dU = cellfun(@<a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/plus.html" class="code" title="function z = plus( x, y )">plus</a>, X.dU, Y.dU, <span class="string">'UniformOutput'</span>, false);
0236         <span class="keyword">end</span>
0237 
0238         <a name="_sub3" href="#_subfunctions" class="code">function X = minus(X, Y)</a>
0239             <span class="comment">%MINUS substracts two tangent tensors</span>
0240             <span class="comment">%</span>
0241             <span class="comment">%   RES = minus(X, Y) substracts two tangent tensors in factorized form. Both tangent tensors</span>
0242             <span class="comment">%   have be elements of the SAME tangent space.</span>
0243             <span class="comment">%</span>
0244 
0245             X.dU = cellfun(@<a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/minus.html" class="code" title="function z = minus( x, y )">minus</a>, X.dU, Y.dU, <span class="string">'UniformOutput'</span>, false);
0246         <span class="keyword">end</span>
0247 
0248         <a name="_sub4" href="#_subfunctions" class="code">function X = mtimes(a, X)</a>
0249             <span class="comment">%MTIMES Multiplication of TTeMPS tangent tensor by scalar</span>
0250             <span class="comment">%</span>
0251             <span class="comment">%   RES = mtimes(a, X) multiplies the TTeMPS tangent tensor X</span>
0252             <span class="comment">%   by the scalar a.</span>
0253             <span class="comment">%</span>
0254 
0255             X.dU = cellfun(@(x) a * x, X.dU, <span class="string">'UniformOutput'</span>, false);
0256         <span class="keyword">end</span>
0257 
0258         <a name="_sub5" href="#_subfunctions" class="code">function X = uminus(X)</a>
0259             <span class="comment">%UMINUS Unary minus of TTeMPS tangent tensor.</span>
0260             <span class="comment">%</span>
0261             <span class="comment">%   RES = uminus(X) negates the TTeMPS tangent tensor X.</span>
0262             <span class="comment">%</span>
0263 
0264             X = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/mtimes.html" class="code" title="function x = mtimes( a, x )">mtimes</a>(-1, X);
0265         <span class="keyword">end</span>
0266 
0267         <a name="_sub6" href="#_subfunctions" class="code">function Xnew = tangentAdd(Z, t, retract)</a>
0268             <span class="comment">%TANGENTADD adds a tangent vector to a point on the manifold</span>
0269             <span class="comment">%</span>
0270             <span class="comment">%   RES = tangentAdd(Z, t ) adds a tangent vector Z to the current point on the rank-r-manifold, scaled by t:</span>
0271             <span class="comment">%           res = X + t*Z</span>
0272             <span class="comment">%   where the result is stored as a TTeMPS tensor of rank 2*r.</span>
0273             <span class="comment">%</span>
0274             <span class="comment">%   RES = tangentAdd(Z, t, true) adds a tangent vector Z to the current point X on the rank-r-manifold, scaled by t:</span>
0275             <span class="comment">%           res = X + t*Z</span>
0276             <span class="comment">%   and retracts the result back to the manifold:</span>
0277             <span class="comment">%           res = R_X( X + t*Z )</span>
0278             <span class="comment">%   where the result is stored as a right orthogonal TTeMPS tensor of rank r.</span>
0279             <span class="comment">%</span>
0280 
0281             <span class="keyword">if</span> ~exist(<span class="string">'retract'</span>, <span class="string">'var'</span>)
0282                 retract = false;
0283             <span class="keyword">end</span>
0284 
0285             d = length(Z.dU);
0286             r = ones(1, d + 1);
0287             C = cell(1, d);
0288 
0289             C{1} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, t * Z.dU{1}, Z.U{1});
0290 
0291             <span class="keyword">for</span> i = 2:d - 1
0292                 sz = size(Z.U{i});
0293                 r(i) = sz(1);
0294                 zeroblock = zeros(sz);
0295                 tmp1 = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, Z.V{i}, zeroblock);
0296                 tmp2 = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, t * Z.dU{i}, Z.U{i});
0297                 C{i} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, tmp1, tmp2);
0298             <span class="keyword">end</span>
0299 
0300             r(d) = size(Z.U{d}, 1);
0301             C{d} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, Z.V{d}, Z.U{d} + t * Z.dU{d});
0302             Xnew = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/TTeMPS.html" class="code" title="">TTeMPS</a>(C);
0303 
0304             <span class="keyword">if</span> retract
0305                 Xnew = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/truncate.html" class="code" title="function x = truncate( x, r )">truncate</a>(Xnew, r);
0306             <span class="keyword">end</span>
0307 
0308         <span class="keyword">end</span>
0309 
0310         <a name="_sub7" href="#_subfunctions" class="code">function res = innerprod(Z1, Z2)</a>
0311 
0312             <span class="comment">% due to left-and right orth., inner prod is just the inner product of the dU</span>
0313             res = 0;
0314 
0315             <span class="keyword">for</span> i = 1:length(Z1.dU)
0316                 res = res + Z1.dU{i}(:)' * Z2.dU{i}(:);
0317             <span class="keyword">end</span>
0318 
0319         <span class="keyword">end</span>
0320 
0321         <a name="_sub8" href="#_subfunctions" class="code">function n = norm(Z)</a>
0322             Z_tt = <a href="#_sub11" class="code" title="subfunction res = tangent_to_TTeMPS(Z)">tangent_to_TTeMPS</a>(Z);
0323             n = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/norm.html" class="code" title="function res = norm( x, safe )">norm</a>(Z_tt);
0324         <span class="keyword">end</span>
0325 
0326         <a name="_sub9" href="#_subfunctions" class="code">function res = at_Omega(Z, ind)</a>
0327 
0328             Xnew = <a href="#_sub11" class="code" title="subfunction res = tangent_to_TTeMPS(Z)">tangent_to_TTeMPS</a>(Z);
0329             res = Xnew(ind);
0330         <span class="keyword">end</span>
0331 
0332         <a name="_sub10" href="#_subfunctions" class="code">function res = tangent_to_TTeMPS(Z)</a>
0333             d = length(Z.dU);
0334             C = cell(1, d);
0335 
0336             C{1} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, Z.dU{1}, Z.U{1});
0337 
0338             <span class="keyword">for</span> i = 2:d - 1
0339                 zeroblock = zeros(size(Z.U{i}));
0340                 tmp1 = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, Z.V{i}, zeroblock);
0341                 tmp2 = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(3, Z.dU{i}, Z.U{i});
0342                 C{i} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, tmp1, tmp2);
0343             <span class="keyword">end</span>
0344 
0345             C{d} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/cat.html" class="code" title="function z = cat( mu, x, y )">cat</a>(1, Z.V{d}, Z.dU{d});
0346 
0347             res = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/TTeMPS.html" class="code" title="">TTeMPS</a>(C);
0348         <span class="keyword">end</span>
0349 
0350         <a name="_sub11" href="#_subfunctions" class="code">function z = vectorize_tangent(Z)</a>
0351             z = cellfun(@(x) x(:), Z.dU, <span class="string">'UniformOutput'</span>, false);
0352             z = cell2mat(z(:));
0353         <span class="keyword">end</span>
0354 
0355         <a name="_sub12" href="#_subfunctions" class="code">function Z = fill_with_vectorized(Z, z)</a>
0356             d = length(Z.dU);
0357             k = 1;
0358 
0359             <span class="keyword">for</span> i = 1:d
0360                 s = size(Z.dU{i});
0361                 Z.dU{i} = reshape(z(k:k + prod(s) - 1), s);
0362                 k = k + prod(s);
0363             <span class="keyword">end</span>
0364 
0365         <span class="keyword">end</span>
0366 
0367         <a name="_sub13" href="#_subfunctions" class="code">function xi = tangent_orth_to_tangent(Z)</a>
0368             <span class="comment">% Transform a TTeMPS_tangent_orth to a TTeMPS_tangent.</span>
0369             d = Z.order;
0370             xL = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/TTeMPS.html" class="code" title="">TTeMPS</a>(Z.U);
0371             [xL, xR, G] = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS/gauge_matrices.html" class="code" title="function [xL, xR, G] = gauge_matrices( x )">gauge_matrices</a>(xL);
0372 
0373             xi = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/@TTeMPS_tangent/TTeMPS_tangent.html" class="code" title="">TTeMPS_tangent</a>(xL);
0374 
0375             <span class="keyword">for</span> ii = 1:d - 1
0376                 xi.dU{ii} = <a href="../../../../../manopt/manifolds/ttfixedrank/TTeMPS_1.1/tensorprod.html" class="code" title="function res = tensorprod( U, A, mode, apply_inv )">tensorprod</a>(Z.dU{ii}, inv(G{ii}'), 3);
0377             <span class="keyword">end</span>
0378 
0379             <span class="comment">% the lc;last one does not need to be changed</span>
0380             xi.dU{d} = Z.dU{d};
0381         <span class="keyword">end</span>
0382 
0383     <span class="keyword">end</span>
0384 
0385     methods (Static, Access = private)
0386 
0387         x = TTeMPS_tangent_orth_omega(n, r, CU, CV, ind, vals);
0388         x = TTeMPS_tangent_orth_omega_openmp(n, r, CU, CV, ind, vals);
0389 
0390     <span class="keyword">end</span>
0391 
0392 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 05-Sep-2021 17:57:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>