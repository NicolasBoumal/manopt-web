<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of checkhessian</title>
  <meta name="keywords" content="checkhessian">
  <meta name="description" content="Checks the consistency of the cost function and the Hessian.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">manopt</a> &gt; <a href="index.html">tools</a> &gt; checkhessian.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for manopt\tools&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>checkhessian
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Checks the consistency of the cost function and the Hessian.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function checkhessian(problem, x, d) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Checks the consistency of the cost function and the Hessian.

 function checkhessian(problem)
 function checkhessian(problem, x)
 function checkhessian(problem, x, d)

 checkhessian performs a numerical test to check that the directional
 derivatives and Hessian defined in the problem structure agree up to
 second order with the cost function at some point x, along some direction
 d. The test is based on a truncated Taylor series (see online Manopt
 documentation).
 
 It is also tested that the Hessian along some direction is indeed a
 tangent vector and that the Hessian operator is symmetric w.r.t. the
 Riemannian metric.
 
 Both x and d are optional and will be sampled at random if omitted.

 See also: <a href="checkdiff.html" class="code" title="function checkdiff(problem, x, d)">checkdiff</a> <a href="checkgradient.html" class="code" title="function checkgradient(problem, x, d)">checkgradient</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../manopt/privatetools/canGetCost.html" class="code" title="function candoit = canGetCost(problem)">canGetCost</a>	Checks whether the cost function can be computed for a problem structure.</li><li><a href="../../manopt/privatetools/canGetGradient.html" class="code" title="function candoit = canGetGradient(problem)">canGetGradient</a>	Checks whether the gradient can be computed for a problem structure.</li><li><a href="../../manopt/privatetools/canGetHessian.html" class="code" title="function candoit = canGetHessian(problem)">canGetHessian</a>	Checks whether the Hessian can be computed for a problem structure.</li><li><a href="../../manopt/privatetools/getCost.html" class="code" title="function [cost, storedb] = getCost(problem, x, storedb)">getCost</a>	Computes the cost function at x.</li><li><a href="../../manopt/privatetools/getDirectionalDerivative.html" class="code" title="function [diff, storedb] = getDirectionalDerivative(problem, x, d, storedb)">getDirectionalDerivative</a>	Computes the directional derivative of the cost function at x along d.</li><li><a href="../../manopt/privatetools/getHessian.html" class="code" title="function [hess, storedb] = getHessian(problem, x, d, storedb)">getHessian</a>	Computes the Hessian of the cost function at x along d.</li><li><a href="identify_linear_piece.html" class="code" title="function [range, poly] = identify_linear_piece(x, y, window_length)">identify_linear_piece</a>	Identify a segment of the curve (x, y) that appears to be linear.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../examples/truncated_svd.html" class="code" title="function [U S V info] = truncated_svd(A, p)">truncated_svd</a>	Returns an SVD decomposition of A truncated to rank p.</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function checkhessian(problem, x, d)</a>
0002 <span class="comment">% Checks the consistency of the cost function and the Hessian.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% function checkhessian(problem)</span>
0005 <span class="comment">% function checkhessian(problem, x)</span>
0006 <span class="comment">% function checkhessian(problem, x, d)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% checkhessian performs a numerical test to check that the directional</span>
0009 <span class="comment">% derivatives and Hessian defined in the problem structure agree up to</span>
0010 <span class="comment">% second order with the cost function at some point x, along some direction</span>
0011 <span class="comment">% d. The test is based on a truncated Taylor series (see online Manopt</span>
0012 <span class="comment">% documentation).</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% It is also tested that the Hessian along some direction is indeed a</span>
0015 <span class="comment">% tangent vector and that the Hessian operator is symmetric w.r.t. the</span>
0016 <span class="comment">% Riemannian metric.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% Both x and d are optional and will be sampled at random if omitted.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% See also: checkdiff checkgradient</span>
0021 
0022 <span class="comment">% This file is part of Manopt: www.manopt.org.</span>
0023 <span class="comment">% Original author: Nicolas Boumal, Dec. 30, 2012.</span>
0024 <span class="comment">% Contributors:</span>
0025 <span class="comment">% Change log:</span>
0026 
0027         
0028     <span class="comment">% Verify that the problem description is sufficient.</span>
0029     <span class="keyword">if</span> ~<a href="../../manopt/privatetools/canGetCost.html" class="code" title="function candoit = canGetCost(problem)">canGetCost</a>(problem)
0030         error(<span class="string">'It seems no cost was provided.'</span>);  
0031     <span class="keyword">end</span>
0032     <span class="keyword">if</span> ~<a href="../../manopt/privatetools/canGetGradient.html" class="code" title="function candoit = canGetGradient(problem)">canGetGradient</a>(problem)
0033         error(<span class="string">'It seems no gradient provided.'</span>);    
0034     <span class="keyword">end</span>
0035     <span class="keyword">if</span> ~<a href="../../manopt/privatetools/canGetHessian.html" class="code" title="function candoit = canGetHessian(problem)">canGetHessian</a>(problem)
0036         error(<span class="string">'It seems no Hessian was provided.'</span>);    
0037     <span class="keyword">end</span>
0038     
0039     dbstore = struct();
0040     
0041     x_isprovided = exist(<span class="string">'x'</span>, <span class="string">'var'</span>) &amp;&amp; ~isempty(x);
0042     d_isprovided = exist(<span class="string">'d'</span>, <span class="string">'var'</span>) &amp;&amp; ~isempty(d);
0043     
0044     <span class="keyword">if</span> ~x_isprovided &amp;&amp; d_isprovided
0045         error(<span class="string">'If d is provided, x must be too, since d is tangent at x.'</span>);
0046     <span class="keyword">end</span>
0047     
0048     <span class="comment">% If x and / or d are not specified, pick them at random.</span>
0049     <span class="keyword">if</span> ~x_isprovided
0050         x = problem.M.rand();
0051     <span class="keyword">end</span>
0052     <span class="keyword">if</span> ~d_isprovided
0053         d = problem.M.randvec(x);
0054     <span class="keyword">end</span>
0055     
0056     <span class="comment">%% Check that the directional derivative and the Hessian at x along d</span>
0057     <span class="comment">%% yield a second order model of the cost function.</span>
0058     
0059     <span class="comment">% Compute the value f0 at f, directional derivative df0 at x along d,</span>
0060     <span class="comment">% and Hessian along [d, d].</span>
0061     f0 = <a href="../../manopt/privatetools/getCost.html" class="code" title="function [cost, storedb] = getCost(problem, x, storedb)">getCost</a>(problem, x, dbstore);
0062     df0 = <a href="../../manopt/privatetools/getDirectionalDerivative.html" class="code" title="function [diff, storedb] = getDirectionalDerivative(problem, x, d, storedb)">getDirectionalDerivative</a>(problem, x, d, dbstore);
0063     d2f0 = problem.M.inner(x, d, <a href="../../manopt/privatetools/getHessian.html" class="code" title="function [hess, storedb] = getHessian(problem, x, d, storedb)">getHessian</a>(problem, x, d, dbstore));
0064     
0065     <span class="comment">% Compute the value of f at points on the geodesic (or approximation of</span>
0066     <span class="comment">% it) originating from x, along direction d, for stepsizes in a large</span>
0067     <span class="comment">% range given by h.</span>
0068     h = logspace(-8, 0, 51);
0069     value = zeros(size(h));
0070     <span class="keyword">for</span> i = 1 : length(h)
0071         y = problem.M.exp(x, d, h(i));
0072         value(i) = <a href="../../manopt/privatetools/getCost.html" class="code" title="function [cost, storedb] = getCost(problem, x, storedb)">getCost</a>(problem, y, dbstore);
0073     <span class="keyword">end</span>
0074     
0075     <span class="comment">% Compute the quadratic approximation of the cost function using f0,</span>
0076     <span class="comment">% df0 and d2f0 at the same points.</span>
0077     model = polyval([.5*d2f0 df0 f0], h);
0078     
0079     <span class="comment">% Compute the approximation error</span>
0080     err = abs(model - value);
0081     
0082     <span class="comment">% And plot it.</span>
0083     loglog(h, err);
0084     title(sprintf([<span class="string">'Hessian check.\nThe slope of the continuous line '</span> <span class="keyword">...</span>
0085                    <span class="string">'should match that of the dashed (reference) line\n'</span> <span class="keyword">...</span>
0086                    <span class="string">'over at least a few orders of magnitude for h.'</span>]));
0087     xlabel(<span class="string">'h'</span>);
0088     ylabel(<span class="string">'Approximation error'</span>);
0089     
0090     line(<span class="string">'xdata'</span>, [1e-8 1e0], <span class="string">'ydata'</span>, [1e-16 1e8], <span class="keyword">...</span>
0091          <span class="string">'color'</span>, <span class="string">'k'</span>, <span class="string">'LineStyle'</span>, <span class="string">'--'</span>, <span class="keyword">...</span>
0092          <span class="string">'YLimInclude'</span>, <span class="string">'off'</span>, <span class="string">'XLimInclude'</span>, <span class="string">'off'</span>);
0093     
0094     <span class="comment">% In a numerically reasonable neighborhood, the error should decrease</span>
0095     <span class="comment">% as the cube of the stepsize, i.e., in loglog scale, the error</span>
0096     <span class="comment">% should have a slope of 3.</span>
0097     window_len = 10;
0098     [range poly] = <a href="identify_linear_piece.html" class="code" title="function [range, poly] = identify_linear_piece(x, y, window_length)">identify_linear_piece</a>(log10(h), log10(err), window_len);
0099     hold on;
0100         loglog(h(range), 10.^polyval(poly, log10(h(range))), <span class="keyword">...</span>
0101                <span class="string">'r-'</span>, <span class="string">'LineWidth'</span>, 3);
0102     hold off;
0103     
0104     fprintf(<span class="string">'The slope should be 3. It appears to be: %g.\n'</span>, poly(1));
0105     fprintf([<span class="string">'If it is far from 3, then directional derivatives or '</span> <span class="keyword">...</span>
0106              <span class="string">'the Hessian might be erroneous.\n'</span>]);
0107 
0108     
0109     <span class="comment">%% Check that the Hessian at x along direction d is a tangent vector.</span>
0110     <span class="keyword">if</span> isfield(problem.M, <span class="string">'tangent'</span>)
0111         hess = <a href="../../manopt/privatetools/getHessian.html" class="code" title="function [hess, storedb] = getHessian(problem, x, d, storedb)">getHessian</a>(problem, x, d, dbstore);
0112         phess = problem.M.tangent(x, hess);
0113         residual = problem.M.lincomb(x, 1, hess, -1, phess);
0114         err = problem.M.norm(x, residual);
0115         fprintf(<span class="string">'The residual should be zero, or very close. '</span>);
0116         fprintf(<span class="string">'Residual: %g.\n'</span>, err);
0117         fprintf([<span class="string">'If it is far from 0, then the Hessian is not in the '</span> <span class="keyword">...</span>
0118                  <span class="string">'tangent plane.\n'</span>]);
0119     <span class="keyword">else</span>
0120         fprintf([<span class="string">'Unfortunately, Manopt was un able to verify that the '</span><span class="keyword">...</span>
0121                  <span class="string">'Hessian is indeed a tangent vector.\nPlease verify '</span> <span class="keyword">...</span>
0122                  <span class="string">'this manually.'</span>]);
0123     <span class="keyword">end</span>    
0124     
0125     <span class="comment">%% Check that the Hessian at x is symmetric.</span>
0126     d1 = problem.M.randvec(x);
0127     d2 = problem.M.randvec(x);
0128     h1 = <a href="../../manopt/privatetools/getHessian.html" class="code" title="function [hess, storedb] = getHessian(problem, x, d, storedb)">getHessian</a>(problem, x, d1, dbstore);
0129     h2 = <a href="../../manopt/privatetools/getHessian.html" class="code" title="function [hess, storedb] = getHessian(problem, x, d, storedb)">getHessian</a>(problem, x, d2, dbstore);
0130     v1 = problem.M.inner(x, d1, h2);
0131     v2 = problem.M.inner(x, h1, d2);
0132     value = v1-v2;
0133     fprintf([<span class="string">'&lt;d1, H[d2]&gt; - &lt;H[d1], d2&gt; should be zero, or very close.'</span> <span class="keyword">...</span>
0134              <span class="string">'\n\tValue: %g - %g = %g.\n'</span>], v1, v2, value);
0135     fprintf(<span class="string">'If it is far from 0, then the Hessian is not symmetric.\n'</span>);
0136     
0137 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 12-Aug-2014 11:52:39 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>